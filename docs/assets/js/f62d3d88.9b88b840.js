"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[912],{3905:(e,t,n)=>{n.d(t,{Zo:()=>l,kt:()=>u});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),d=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},l=function(e){var t=d(e.components);return a.createElement(p.Provider,{value:t},e.children)},c="mdxType",f={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,l=o(e,["components","mdxType","originalType","parentName"]),c=d(n),m=r,u=c["".concat(p,".").concat(m)]||c[m]||f[m]||i;return n?a.createElement(u,s(s({ref:t},l),{},{components:n})):a.createElement(u,s({ref:t},l))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,s=new Array(i);s[0]=m;var o={};for(var p in t)hasOwnProperty.call(t,p)&&(o[p]=t[p]);o.originalType=e,o[c]="string"==typeof e?e:r,s[1]=o;for(var d=2;d<i;d++)s[d]=n[d];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},2086:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>s,default:()=>f,frontMatter:()=>i,metadata:()=>o,toc:()=>d});var a=n(7462),r=(n(7294),n(3905));const i={},s="Two-phase Transfer",o={unversionedId:"usage/two-phase-transfer",id:"usage/two-phase-transfer",title:"Two-phase Transfer",description:'The name "two-phase transfer" is a reference to the [two-phase commit',source:"@site/pages/usage/two-phase-transfer.md",sourceDirName:"usage",slug:"/usage/two-phase-transfer",permalink:"/usage/two-phase-transfer",draft:!1,editUrl:"https://github.com/tigerbeetledb/tigerbeetle/blob/main/docs/usage/two-phase-transfer.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Integration",permalink:"/usage/integration"},next:{title:".NET",permalink:"/clients/dotnet"}},p={},d=[{value:"Posting a subset of pending <code>amount</code>",id:"posting-a-subset-of-pending-amount",level:2},{value:"Timeouts",id:"timeouts",level:2},{value:"<code>credits_must_not_exceed_debits</code> and <code>debits_must_not_exceed_credits</code>",id:"credits_must_not_exceed_debits-and-debits_must_not_exceed_credits",level:2},{value:"Pessimistic pending transfers",id:"pessimistic-pending-transfers",level:3},{value:"All transfers are immutable",id:"all-transfers-are-immutable",level:2},{value:"Client documentation",id:"client-documentation",level:2},{value:"Client samples",id:"client-samples",level:2}],l={toc:d},c="wrapper";function f(e){let{components:t,...n}=e;return(0,r.kt)(c,(0,a.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"two-phase-transfer"},"Two-phase Transfer"),(0,r.kt)("p",null,'The name "two-phase transfer" is a reference to the ',(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Two-phase_commit_protocol"},"two-phase commit\nprotocol for distributed\ntransactions"),"."),(0,r.kt)("p",null,"Single-phase transfers post funds to accounts immediately when they\nare created. That is, they increase the\n",(0,r.kt)("a",{parentName:"p",href:"/reference/accounts#debits_posted"},(0,r.kt)("inlineCode",{parentName:"a"},"debits_posted"))," and\n",(0,r.kt)("a",{parentName:"p",href:"/reference/accounts#credits_posted"},(0,r.kt)("inlineCode",{parentName:"a"},"credits_posted"))," fields on\nrespective accounts."),(0,r.kt)("p",null,"In contrast to single-phase transfers, a two-phase transfer moves\nfunds in stages:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"First, the pending transfer reserves funds. While reserved, they\ncannot be used by either the payer or payee. Only the\n",(0,r.kt)("a",{parentName:"p",href:"/reference/accounts#debits_pending"},(0,r.kt)("inlineCode",{parentName:"a"},"debits_pending"))," and\n",(0,r.kt)("a",{parentName:"p",href:"/reference/accounts#credits_pending"},(0,r.kt)("inlineCode",{parentName:"a"},"credits_pending"))," fields are\nincreased on the relevant accounts at this point.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Later, the application creates another transfer \u2014 with either of\nthe following flags:"))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/reference/transfers#flagspost_pending_transfer"},(0,r.kt)("inlineCode",{parentName:"a"},"post_pending_transfer")),": Move all (or part) of the reserved funds to the pending transfer's destination."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/reference/transfers#flagsvoid_pending_transfer"},(0,r.kt)("inlineCode",{parentName:"a"},"void_pending_transfer")),": Revert all of the reserved funds to the original account.")),(0,r.kt)("p",null,"A pending transfer can only be posted or voided once. It cannot be\nposted twice or voided then posted, etc."),(0,r.kt)("p",null,"When the pending transfer is resolved (posted or voided), the\n",(0,r.kt)("a",{parentName:"p",href:"/reference/accounts#debits_pending"},(0,r.kt)("inlineCode",{parentName:"a"},"debits_pending"))," and\n",(0,r.kt)("a",{parentName:"p",href:"/reference/accounts#credits_pending"},(0,r.kt)("inlineCode",{parentName:"a"},"credits_pending"))," fields\non the respective accounts are decreased by the\n",(0,r.kt)("a",{parentName:"p",href:"/reference/transfers#amount"},(0,r.kt)("inlineCode",{parentName:"a"},"amount"))," of the ",(0,r.kt)("strong",{parentName:"p"},"pending")," transfer."),(0,r.kt)("p",null,"When the pending transfer is posted,\n",(0,r.kt)("a",{parentName:"p",href:"/reference/accounts#debits_posted"},(0,r.kt)("inlineCode",{parentName:"a"},"debits_posted"))," and\n",(0,r.kt)("a",{parentName:"p",href:"/reference/accounts#credits_posted"},(0,r.kt)("inlineCode",{parentName:"a"},"credits_posted"))," fields on\nthe respective accounts are increased by the ",(0,r.kt)("strong",{parentName:"p"},"posting")," transfer's\n",(0,r.kt)("a",{parentName:"p",href:"/reference/transfers#amount"},(0,r.kt)("inlineCode",{parentName:"a"},"amount"))," (which cannot exceed the\npending amount, but need not equal the pending amount either)."),(0,r.kt)("p",null,"When the pending transfer is voided,\n",(0,r.kt)("a",{parentName:"p",href:"/reference/accounts#debits_posted"},(0,r.kt)("inlineCode",{parentName:"a"},"debits_posted"))," and\n",(0,r.kt)("a",{parentName:"p",href:"/reference/accounts#credits_posted"},(0,r.kt)("inlineCode",{parentName:"a"},"credits_posted"))," are not\nmodified."),(0,r.kt)("h2",{id:"posting-a-subset-of-pending-amount"},"Posting a subset of pending ",(0,r.kt)("inlineCode",{parentName:"h2"},"amount")),(0,r.kt)("p",null,"Although an initial ",(0,r.kt)("a",{parentName:"p",href:"/reference/transfers#amount"},(0,r.kt)("inlineCode",{parentName:"a"},"amount"))," is\nreserved when a pending transfer is created, you can set the\n",(0,r.kt)("a",{parentName:"p",href:"/reference/transfers#amount"},(0,r.kt)("inlineCode",{parentName:"a"},"amount"))," field to that amount ",(0,r.kt)("em",{parentName:"p"},"or"),"\nsmaller than that initial amount when posting a pending transfer."),(0,r.kt)("p",null,"In the event that you post less than the amount you initially\nreserved, the rest of the amount not posted reverts back to the\noriginal account."),(0,r.kt)("h2",{id:"timeouts"},"Timeouts"),(0,r.kt)("p",null,"If a pending transfer is created with a timeout (which is optional),\nthen if it has not been posted or voided by the time the timeout\nexpires, the full amount will be voided."),(0,r.kt)("h2",{id:"credits_must_not_exceed_debits-and-debits_must_not_exceed_credits"},(0,r.kt)("inlineCode",{parentName:"h2"},"credits_must_not_exceed_debits")," and ",(0,r.kt)("inlineCode",{parentName:"h2"},"debits_must_not_exceed_credits")),(0,r.kt)("p",null,"The pending transfer's amount is reserved in a way that the second\nstep in a two-phase transfer will never cause the accounts' configured\nbalance invariants\n(",(0,r.kt)("a",{parentName:"p",href:"/reference/accounts#flagscredits_must_not_exceed_debits"},(0,r.kt)("inlineCode",{parentName:"a"},"credits_must_not_exceed_debits")),"\nor\n",(0,r.kt)("a",{parentName:"p",href:"/reference/accounts#flagsdebits_must_not_exceed_credits"},(0,r.kt)("inlineCode",{parentName:"a"},"debits_must_not_exceed_credits")),")\nto be broken, whether the second step is a post or void."),(0,r.kt)("h3",{id:"pessimistic-pending-transfers"},"Pessimistic pending transfers"),(0,r.kt)("p",null,"If an account with\n",(0,r.kt)("a",{parentName:"p",href:"/reference/accounts#flagsdebits_must_not_exceed_credits"},(0,r.kt)("inlineCode",{parentName:"a"},"debits_must_not_exceed_credits")),"\nhas ",(0,r.kt)("inlineCode",{parentName:"p"},"credits_posted = 100")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"debits_posted = 70")," and a pending\ntransfer is started causing the account to have ",(0,r.kt)("inlineCode",{parentName:"p"},"debits_pending = 50"),",\nthe ",(0,r.kt)("em",{parentName:"p"},"pending")," transfer will fail. It will not wait to get to ",(0,r.kt)("em",{parentName:"p"},"posted"),"\nstatus to fail."),(0,r.kt)("h2",{id:"all-transfers-are-immutable"},"All transfers are immutable"),(0,r.kt)("p",null,"To reiterate, completing a two-phase transfer (by either marking it\nvoid or posted) does not involve modifying the pending\ntransfer. Instead you create a new transfer."),(0,r.kt)("p",null,"The first transfer that is marked pending will always have its pending\nflag set."),(0,r.kt)("p",null,"The second transfer will have a\n",(0,r.kt)("a",{parentName:"p",href:"/reference/transfers#flagspost_pending_transfer"},(0,r.kt)("inlineCode",{parentName:"a"},"post_pending_transfer")),"\nor\n",(0,r.kt)("a",{parentName:"p",href:"/reference/transfers#flagsvoid_pending_transfer2"},(0,r.kt)("inlineCode",{parentName:"a"},"void_pending_transfer")),"\nflag set and a ",(0,r.kt)("a",{parentName:"p",href:"/reference/transfers#pending_id"},(0,r.kt)("inlineCode",{parentName:"a"},"pending_id"))," field\nset to the ",(0,r.kt)("a",{parentName:"p",href:"/reference/transfers#id"},(0,r.kt)("inlineCode",{parentName:"a"},"id"))," of the first transfer. The\n",(0,r.kt)("a",{parentName:"p",href:"/reference/transfers#id"},(0,r.kt)("inlineCode",{parentName:"a"},"id"))," of the second transfer will be\nunique, not the same ",(0,r.kt)("a",{parentName:"p",href:"/reference/transfers#id"},(0,r.kt)("inlineCode",{parentName:"a"},"id"))," as the initial\npending transfer."),(0,r.kt)("h2",{id:"client-documentation"},"Client documentation"),(0,r.kt)("p",null,"Read more about how two-phase transfers work with each client."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/clients/node#two-phase-transfers"},"Node")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/clients/go#two-phase-transfers"},"Go")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/clients/java#two-phase-transfers"},"Java"))),(0,r.kt)("h2",{id:"client-samples"},"Client samples"),(0,r.kt)("p",null,"Or take a look at how it works in practice."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/tigerbeetledb/tigerbeetle/blob/main/src/clients/node/samples/two-phase/main.js"},"Node")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/tigerbeetledb/tigerbeetle/blob/main/src/clients/go/samples/two-phase/main.go"},"Go")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/tigerbeetledb/tigerbeetle/blob/main/src/clients/java/samples/two-phase/Main.java"},"Java"))))}f.isMDXComponent=!0}}]);