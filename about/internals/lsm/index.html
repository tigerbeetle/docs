<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-about/internals/lsm" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">LSM | TigerBeetle Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.tigerbeetle.com/about/internals/lsm"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="LSM | TigerBeetle Docs"><meta data-rh="true" name="description" content="Documentation for (roughly) code in the src/lsm directory."><meta data-rh="true" property="og:description" content="Documentation for (roughly) code in the src/lsm directory."><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://docs.tigerbeetle.com/about/internals/lsm"><link data-rh="true" rel="alternate" href="https://docs.tigerbeetle.com/about/internals/lsm" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.tigerbeetle.com/about/internals/lsm" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://NPDIZGXHAP-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="TigerBeetle Docs" href="/opensearch.xml">

<script src="https://plausible.io/js/script.js" defer="defer" data-domain="docs.tigerbeetle.com"></script><link rel="stylesheet" href="/assets/css/styles.f6ff8e1d.css">
<link rel="preload" href="/assets/js/runtime~main.ce6d54b8.js" as="script">
<link rel="preload" href="/assets/js/main.fd7ad820.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="TigerBeetle Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo-white.svg" alt="TigerBeetle Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">TigerBeetle Docs</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tigerbeetle/tigerbeetle" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">TigerBeetle Docs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/quick-start">Quick Start</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/coding/">Coding</a><button aria-label="Toggle the collapsible sidebar category &#x27;Coding&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/operating/deploy">Operating</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/clients/dotnet">Client Libraries</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/reference/account">Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/about/">About</a><button aria-label="Toggle the collapsible sidebar category &#x27;About&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/oltp">Built for OLTP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/performance">Performance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/safety">Safety</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/vopr">Deterministic Simulation Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/production-ready">Production Ready</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/zig">Zig</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/about/internals/">Internals</a><button aria-label="Toggle the collapsible sidebar category &#x27;Internals&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/about/internals/vsr">VSR</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/about/internals/data_file">Data File</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/about/internals/lsm">LSM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/about/internals/sync">State Sync</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/about/internals/testing">Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/about/internals/releases">Releases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/about/internals/cloud">Cloud</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/about/internals/upgrades">Upgrades</a></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/about/"><span itemprop="name">About</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/about/internals/"><span itemprop="name">Internals</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">LSM</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>LSM</h1><p>Documentation for (roughly) code in the <code>src/lsm</code> directory.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="glossary">Glossary<a href="#glossary" class="hash-link" aria-label="Direct link to Glossary" title="Direct link to Glossary">â€‹</a></h2><ul><li><em>bar</em>: <code>lsm_compaction_ops</code> beats; unit of incremental compaction.</li><li><em>beat</em>: <code>op % lsm_compaction_ops</code>; Single step of an incremental compaction.</li><li><em>groove</em>: A collection of LSM trees, storing objects and their indices.</li><li><em>immutable table</em>: In-memory table; one per tree. Used to periodically flush the mutable table to
disk.</li><li><em>level</em>: A collection of on-disk tables, numbering between <code>0</code> and <code>config.lsm_levels - 1</code> (usually <code>config.lsm_levels = 7</code>).</li><li><em>forest</em>: A collection of grooves.</li><li><em>manifest</em>: Index of table and level metadata; one per tree.</li><li><em>mutable table</em>: In-memory table; one per tree. All tree updates (e.g. <code>Tree.put</code>) directly modify just this table.</li><li><em>snapshot</em>: Sequence number which selects the queryable partition of on-disk tables.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tree">Tree<a href="#tree" class="hash-link" aria-label="Direct link to Tree" title="Direct link to Tree">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tables">Tables<a href="#tables" class="hash-link" aria-label="Direct link to Tables" title="Direct link to Tables">â€‹</a></h3><p>A tree is a hierarchy of in-memory and on-disk tables. There are three categories of tables:</p><ul><li>The <a href="https://github.com/tigerbeetle/tigerbeetle/blob/main/src/lsm/table_memory.zig" target="_blank" rel="noopener noreferrer">mutable table</a> is an in-memory table.<ul><li>Each tree has a single mutable table.</li><li>All tree updates, inserts, and removes are applied to the mutable table.</li><li>The mutable table&#x27;s size is allocated to accommodate a full bar of updates.</li></ul></li><li>The <a href="https://github.com/tigerbeetle/tigerbeetle/blob/main/src/lsm/table_memory.zig" target="_blank" rel="noopener noreferrer">immutable table</a> is an in-memory table.<ul><li>Each tree has a single immutable table.</li><li>The mutable table&#x27;s contents are periodically moved to the immutable table,
where they are stored while being flushed to level <code>0</code>.</li></ul></li><li>Level <code>0</code> â€¦ level <code>config.lsm_levels - 1</code> each contain an exponentially increasing number of
immutable on-disk tables.<ul><li>Each tree has as many as <code>config.lsm_growth_factor ^ (level + 1)</code> tables per level.
(<code>config.lsm_growth_factor</code> is typically 8).</li><li>Within a given level and snapshot, the tables&#x27; key ranges are <a href="https://github.com/tigerbeetle/tigerbeetle/blob/main/src/lsm/manifest_level.zig" target="_blank" rel="noopener noreferrer">disjoint</a>.</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="compaction">Compaction<a href="#compaction" class="hash-link" aria-label="Direct link to Compaction" title="Direct link to Compaction">â€‹</a></h3><p>Tree compaction runs to the sound of music!</p><p>Compacting LSM trees involves merging and moving tables into the next levels as needed.
To avoid write amplification stalls and bound latency, compaction is done incrementally.</p><p>A full compaction phase is denoted as a bar, using terms from music notation.
Each bar consists of <code>lsm_compaction_ops</code> beats or &quot;compaction ticks&quot; of work.
A compaction tick executes asynchronously immediately after every commit, with
<code>beat = commit.op % lsm_compaction_ops</code>.</p><p>A bar is split in half according to the &quot;first&quot; beat and &quot;middle&quot; beat.
The first half of the bar compacts even levels while the latter compacts odd levels.
Mutable table changes are sorted and compacted into the immutable table.
The immutable table is compacted into level 0 during the odd level half of the bar.</p><p>At any given point, there are at most <code>âŒˆlevels/2âŒ‰</code> compactions running concurrently.
The source level is denoted as <code>level_a</code> and the target level as <code>level_b</code>.
The last level in the LSM tree has no target level so it is never a source level.
Each compaction compacts a <a href="#compaction-selection-policy">single table</a> from <code>level_a</code> into all tables in
<code>level_b</code> which intersect the <code>level_a</code> table&#x27;s key range.</p><p>Invariants:</p><ul><li>At the end of every beat, there is space in mutable table for the next beat.</li><li>The manifest log is compacted during every half-bar.</li><li>The compactions&#x27; output tables are not <a href="#snapshots-and-compaction">visible</a> until the compaction has finished.</li></ul><ol><li><p>First half-bar, first beat (&quot;first beat&quot;):</p><ul><li>Assert no compactions are currently running.</li><li>Allow the per-level table limits to overflow if needed (for example, if we may compact a table
from level <code>A</code> to level <code>B</code>, where level <code>B</code> is already full).</li><li>Start compactions from even levels that have reached their table limit.</li><li>Acquire reservations from the Free Set for all blocks (upper-bound) that will be written
during this half-bar.</li></ul></li><li><p>First half-bar, last beat:</p><ul><li>Finish ticking any incomplete even-level compactions.</li><li>Assert on callback completion that all compactions are complete.</li><li>Release reservations from the Free Set.</li></ul></li><li><p>Second half-bar, first beat (&quot;middle beat&quot;):</p><ul><li>Assert no compactions are currently running.</li><li>Start compactions from odd levels that have reached their table limit.</li><li>Compact the immutable table if it contains any sorted values (it might be empty).</li><li>Acquire reservations from the Free Set for all blocks (upper-bound) that will be written
during this half-bar.</li></ul></li><li><p>Second half-bar, last beat:</p><ul><li>Finish ticking any incomplete odd-level and immutable table compactions.</li><li>Assert on callback completion that all compactions are complete.</li><li>Assert on callback completion that no level&#x27;s table count overflows.</li><li>Flush, clear, and sort mutable table values into immutable table for next bar.</li><li>Remove input tables that are invisible to all current and persisted snapshots.</li><li>Release reservations from the Free Set.</li></ul></li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="compaction-selection-policy">Compaction Selection Policy<a href="#compaction-selection-policy" class="hash-link" aria-label="Direct link to Compaction Selection Policy" title="Direct link to Compaction Selection Policy">â€‹</a></h4><p>Compaction selects the table from level <code>A</code> which overlaps the fewest visible tables of level <code>B</code>.</p><p>For example, in the following table (with <code>lsm_growth_factor=2</code>), each table is depicted as the range of keys it includes. The tables with uppercase letters would be chosen for compaction next.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Level 0   Aâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€H       lâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Level 1   aâ”€â”€â”€â”€â”€â”€â”€e             Lâ”€M   oâ”€â”€â”€â”€â”€â”€â”€s   uâ”€â”€â”€â”€â”€â”€â”€y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Level 2     bâ”€â”€â”€d eâ”€â”€â”€â”€â”€h iâ”€â”€â”€k lâ”€â”€â”€n oâ”€p qâ”€â”€â”€s   uâ”€v wâ”€â”€â”€â”€â”€z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(Keys)    a b c d e f g h i j k l m n o p q r s t u v w x y z</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Links:</p><ul><li><a href="https://github.com/tigerbeetle/tigerbeetle/blob/main/src/lsm/manifest.zig" target="_blank" rel="noopener noreferrer"><code>Manifest.compaction_table</code></a></li><li><a href="http://vldb.org/pvldb/vol14/p2216-sarkar.pdf" target="_blank" rel="noopener noreferrer">Constructing and Analyzing the LSM Compaction Design Space</a> describes the tradeoffs of various data movement policies. TigerBeetle implements the &quot;least overlapping with parent&quot; policy.</li><li><a href="https://rocksdb.org/blog/2016/01/29/compaction_pri.html" target="_blank" rel="noopener noreferrer">Option of Compaction Priority</a></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="compaction-move-table">Compaction Move Table<a href="#compaction-move-table" class="hash-link" aria-label="Direct link to Compaction Move Table" title="Direct link to Compaction Move Table">â€‹</a></h5><p>When the <a href="#compaction-selection-policy">selected input table</a> from level <code>A</code> does not overlap <em>any</em>
input tables in level <code>B</code>, the input table can be &quot;moved&quot; to level <code>B</code>.
That is, instead of sort-merging <code>A</code> and <code>B</code>, just update the input table&#x27;s metadata in the manifest.</p><p>This is referred to as the <em>move table</em> optimization.</p><p>Where a tree performs inserts mostly in sort order, with a minimum of updates, this <em>move table</em>
optimization should enable the tree&#x27;s performance to approach that of an append-only log.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="compaction-table-overlap">Compaction Table Overlap<a href="#compaction-table-overlap" class="hash-link" aria-label="Direct link to Compaction Table Overlap" title="Direct link to Compaction Table Overlap">â€‹</a></h5><p>Applying <a href="#compaction-selection-policy">this</a> selection policy while compacting a table
from level A to level B, what is the maximum number of level-B tables that may overlap with the
selected level-A table (i.e. the &quot;worst case&quot;)?</p><p>Perhaps surprisingly, this is <code>lsm_growth_factor</code>:</p><ul><li>Tables within a level are disjoint.</li><li>Level <code>B</code> has at most <code>lsm_growth_factor</code> times as many tables as level <code>A</code>.</li><li>To trigger compaction, level <code>A</code>&#x27;s visible-table count exceeds
<code>table_count_max_for_level(lsm_growth_factor, level_a)</code>.</li><li>The <a href="#compaction-selection-policy">selection policy</a> chooses the table from level <code>A</code>
which overlaps the fewest visible tables in level <code>B</code>.</li><li>If any table in level <code>A</code> overlaps <em>more than</em> <code>lsm_growth_factor</code> tables in level <code>B</code>,
that implies the existence of a table in level <code>A</code> with <em>less than</em> <code>lsm_growth_factor</code> overlap.
The latter table would be selected over the former.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="snapshots">Snapshots<a href="#snapshots" class="hash-link" aria-label="Direct link to Snapshots" title="Direct link to Snapshots">â€‹</a></h3><p>Each table has a minimum and maximum integer snapshot (<code>snapshot_min</code> and <code>snapshot_max</code>).</p><p>Each query targets a particular snapshot. A table <code>T</code> is <em>visible</em> to a snapshot <code>S</code> when</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">T.snapshot_min â‰¤ S â‰¤ T.snapshot_max</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and is <em>invisible</em> to the snapshot otherwise.</p><p>Compaction does not modify tables in place â€” it copies data. Snapshots control and distinguish
which copies are useful, and which can be deleted. Snapshots can also be persisted, enabling
queries against past states of the tree (unimplemented; future work).</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="snapshots-and-compaction">Snapshots and Compaction<a href="#snapshots-and-compaction" class="hash-link" aria-label="Direct link to Snapshots and Compaction" title="Direct link to Snapshots and Compaction">â€‹</a></h4><p>Consider the half-bar compaction beginning at op=<code>X</code> (<code>12</code>), with <code>lsm_compaction_ops=M</code> (<code>8</code>).
Each half-bar contains <code>N=M/2</code> (<code>4</code>) beats. The next half-bar begins at <code>Y=X+N</code> (<code>16</code>).</p><p>During the half-bar compaction <code>X</code>:</p><ul><li><code>snapshot_max</code> of each input table is truncated to <code>Y-1</code> (<code>15</code>).</li><li><code>snapshot_min</code> of each output table is initialized to <code>Y</code> (<code>16</code>).</li><li><code>snapshot_max</code> of each output table is initialized to <code>âˆ</code>.</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0   4   8  12  16  20  24  (op, snapshot)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â”¼â”€â”€â”€â”¬â”€â”€â”€â”¼â”€â”€â”€â”¬â”€â”€â”€â”¼â”€â”€â”€â”¬â”€â”€â”€â”¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ####</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Â·Â·Â·Â·â”€â”€â”€â”€â”€â”€â”€â”€Xâ”€â”€â”€â”€â”€â”€â”€â”€Â·Â·Â·Â·  (input  tables, before compaction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Â·Â·Â·Â·â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           (input  tables,  after compaction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Yâ”€â”€â”€â”€Â·Â·Â·Â·  (output tables,  after compaction)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Beginning from the next op after the compaction (<code>Y</code>; <code>16</code>):</p><ul><li>The output tables of the above compaction <code>X</code> are visible.</li><li>The input tables of the above compaction <code>X</code> are invisible.</li><li>Therefore, it will lookup from the output tables, but ignore the input tables.</li><li>Callers must not query from the output tables of <code>X</code> before the compaction half-bar has finished
(i.e. before the end of beat <code>Y-1</code> (<code>15</code>)), since those tables are incomplete.</li></ul><p>At this point the input tables can be removed if they are invisible to all persistent snapshots.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="snapshot-queries">Snapshot Queries<a href="#snapshot-queries" class="hash-link" aria-label="Direct link to Snapshot Queries" title="Direct link to Snapshot Queries">â€‹</a></h4><p>Each query targets a particular snapshot, either:</p><ul><li>the current snapshot (<code>snapshot_latest</code>), or</li><li>a <a href="#persistent-snapshots">persisted snapshot</a>.</li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="persistent-snapshots">Persistent Snapshots<a href="#persistent-snapshots" class="hash-link" aria-label="Direct link to Persistent Snapshots" title="Direct link to Persistent Snapshots">â€‹</a></h5><p>TODO(Persistent Snapshots): Expand this section.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="snapshot-values">Snapshot Values<a href="#snapshot-values" class="hash-link" aria-label="Direct link to Snapshot Values" title="Direct link to Snapshot Values">â€‹</a></h4><ul><li>The on-disk tables visible to a snapshot <code>B</code> do not contain the updates from the commit with op <code>B</code>.</li><li>Rather, snapshot <code>B</code> is first visible to a prefetch from the commit with op <code>B</code>.</li></ul><p>Consider the following diagram (<code>lsm_compaction_ops=8</code>):</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0   4   8  12  16  20  24  28  (op, snapshot)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â”¼â”€â”€â”€â”¬â”€â”€â”€â”¼â”€â”€â”€â”¬â”€â”€â”€â”¼â”€â”€â”€â”¬â”€â”€â”€â”¼â”€â”€â”€â”¬</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ,,,,,,,,........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        â†‘A      â†‘B      â†‘C</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Compaction is driven by the commits of ops <code>Bâ†’C</code> (<code>16â€¦23</code>). While these ops are being committed:</p><ul><li>Updates from ops <code>0â†’A</code> (<code>0â€¦7</code>) are on-disk.</li><li>Updates from ops <code>Aâ†’B</code> (<code>8â€¦15</code>) are in the immutable table.<ul><li>These updates were moved to the immutable table from the immutable table at the end of op <code>B-1</code>
(<code>15</code>).</li><li>These updates will exist in the immutable table until it is reset at the end of op <code>C-1</code> (<code>23</code>).</li></ul></li><li>Updates from ops <code>Bâ†’C</code> (<code>16â€¦23</code>) are added to the mutable table (by the respective commit).</li><li><code>tree.lookup_snapshot_max</code> is <code>B</code> when committing op <code>B</code>.</li><li><code>tree.lookup_snapshot_max</code> is <code>x</code> when committing op <code>x</code> (for <code>x âˆˆ {16,17,â€¦,23}</code>).</li></ul><p>At the end of the last beat of the compaction bar (<code>23</code>):</p><ul><li>Updates from ops <code>0â†’B</code> (<code>0â€¦15</code>) are on disk.</li><li>Updates from ops <code>Bâ†’C</code> (<code>16â€¦23</code>) are moved from the mutable table to the immutable table.</li><li><code>tree.lookup_snapshot_max</code> is <code>x</code> when committing op <code>x</code> (for <code>x âˆˆ {24,25,â€¦}</code>).</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="manifest">Manifest<a href="#manifest" class="hash-link" aria-label="Direct link to Manifest" title="Direct link to Manifest">â€‹</a></h3><p>The manifest is a tree&#x27;s index of table locations and metadata.</p><p>Each manifest has two components:</p><ul><li>a single <a href="#manifest-log"><code>ManifestLog</code></a> shared by all trees and levels, and</li><li>one <a href="#manifest-level"><code>ManifestLevel</code></a> for each on-disk level.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="manifest-log">Manifest Log<a href="#manifest-log" class="hash-link" aria-label="Direct link to Manifest Log" title="Direct link to Manifest Log">â€‹</a></h4><p>The manifest log is an on-disk log of all updates to the trees&#x27; table indexes.</p><p>The manifest log tracks:</p><ul><li>tables created as compaction output</li><li>tables updated as compaction input (modifying their <code>snapshot_max</code>)</li><li>tables moved between levels by compaction</li><li>tables deleted after compaction</li></ul><p>Updates are accumulated in-memory before being flushed:</p><ul><li>incrementally during compaction, or</li><li>in their entirety during checkpoint.</li></ul><p>The manifest log is periodically compacted to remove older entries that have been superseded by
newer entries. For example, if a table is created and later deleted, manifest log compaction
will eventually remove any reference to the table from the log blocks.</p><p>Each manifest block has a reference to the (chronologically) previous manifest block.
The superblock stores the head and tail address/checksum of this linked list.
The reference on the header of the head manifest block &quot;dangles&quot; â€“ the block it references has already been compacted.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="manifest-level">Manifest Level<a href="#manifest-level" class="hash-link" aria-label="Direct link to Manifest Level" title="Direct link to Manifest Level">â€‹</a></h4><p>A <code>ManifestLevel</code> is an in-memory collection of the table metadata for a single level of a tree.</p><p>For a given level and snapshot, there may be gaps in the key ranges of the visible tables,
but the key ranges are disjoint.</p><p>Manifest levels are queried for tables at a target snapshot and within a key range.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="example">Example<a href="#example" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">â€‹</a></h5><p>Given the <code>ManifestLevel</code> tables (with values chosen for visualization, not realism):</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       label   A   B   C   D   E   F   G   H   I   J   K   L   M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     key_min   0   4  12  16   4   8  12  26   4  25   4  16  24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     key_max   3  11  15  19   7  11  15  27   7  27  11  19  27</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">snapshot_min   1   1   1   1   3   3   3   3   5   5   7   7   7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">snapshot_max   9   3   3   7   5   7   9   5   7   7   9   9   9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A level&#x27;s tables can be visualized in 2D as a partitioned rectangle:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  0         1         2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0   4   8   2   6   0   4   8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> â”‚   â”‚   K   â”‚   â”‚ L â”‚###â”‚ M â”‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7â”‚   â”œâ”€â”€â”€â”¬â”€â”€â”€â”¤   â”œâ”€â”€â”€â”¤###â””â”¬â”€â”€â”¤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> â”‚   â”‚ I â”‚   â”‚ G â”‚   â”‚####â”‚ Jâ”‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5â”‚ A â”œâ”€â”€â”€â”¤ F â”‚   â”‚   â”‚####â””â”¬â”€â”¤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> â”‚   â”‚ E â”‚   â”‚   â”‚ D â”‚#####â”‚Hâ”‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3â”‚   â”œâ”€â”€â”€â”´â”€â”€â”€â”¼â”€â”€â”€â”¤   â”‚#####â””â”€â”¤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> â”‚   â”‚   B   â”‚ C â”‚   â”‚#######â”‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Example iterations:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">visibility  snapshots   direction  key_min  key_max  tables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   visible          2   ascending        0       28  A, B, C, D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   visible          4   ascending        0       28  A, E, F, G, D, H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   visible          6  descending       12       28  J, D, G</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   visible          8   ascending        0       28  A, K, G, L, M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> invisible    2, 4, 6   ascending        0       28  K, L, M</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Legend:</p><ul><li><code>#</code> represents a gap â€” no tables cover these keys during the snapshot.</li><li>The horizontal axis represents the key range.</li><li>The vertical axis represents the snapshot range.</li><li>Each rectangle is a table within the manifest level.</li><li>The sides of each rectangle depict:<ul><li>left:   <code>table.key_min</code> (the diagram is inclusive, and the <code>table.key_min</code> is inclusive)</li><li>right:  <code>table.key_max</code> (the diagram is EXCLUSIVE, but the <code>table.key_max</code> is INCLUSIVE)</li><li>bottom: <code>table.snapshot_min</code> (inclusive)</li><li>top:    <code>table.snapshot_max</code> (inclusive)</li></ul></li><li>(Not depicted: tables may have <code>table.key_min == table.key_max</code>.)</li><li>(Not depicted: the newest set of tables would have <code>table.snapshot_max == maxInt(u64)</code>.)</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/tigerbeetle/tigerbeetle/blob/main/docs/about/internals/lsm.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/about/internals/data_file"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Data File</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/about/internals/sync"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">State Sync</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#glossary" class="table-of-contents__link toc-highlight">Glossary</a></li><li><a href="#tree" class="table-of-contents__link toc-highlight">Tree</a><ul><li><a href="#tables" class="table-of-contents__link toc-highlight">Tables</a></li><li><a href="#compaction" class="table-of-contents__link toc-highlight">Compaction</a></li><li><a href="#snapshots" class="table-of-contents__link toc-highlight">Snapshots</a></li><li><a href="#manifest" class="table-of-contents__link toc-highlight">Manifest</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a href="https://github.com/tigerbeetle/tigerbeetle" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">Â·</span><a href="https://slack.tigerbeetle.com/invite" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">Â·</span><a href="https://mailchi.mp/8e9fa0f36056/subscribe-to-tigerbeetle" target="_blank" rel="noopener noreferrer" class="footer__link-item">Newsletter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">Â·</span><a href="https://twitter.com/tigerbeetledb" target="_blank" rel="noopener noreferrer" class="footer__link-item">ğ•<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">Â·</span><a href="https://linkedin.com/company/tigerbeetle" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">Â·</span><a href="https://www.youtube.com/@tigerbeetledb" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://tigerbeetle.com/" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/logo-with-text-white.svg" alt="TigerBeetle Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/logo-with-text-white.svg" alt="TigerBeetle Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2025 TigerBeetle, Inc. All rights reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ce6d54b8.js"></script>
<script src="/assets/js/main.fd7ad820.js"></script>
</body>
</html>