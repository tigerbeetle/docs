<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-about/architecture" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Architecture | TigerBeetle Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.tigerbeetle.com/about/architecture"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Architecture | TigerBeetle Docs"><meta data-rh="true" name="description" content="In theory, TigerBeetle is a replicated state machine that takes an initial starting state"><meta data-rh="true" property="og:description" content="In theory, TigerBeetle is a replicated state machine that takes an initial starting state"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://docs.tigerbeetle.com/about/architecture"><link data-rh="true" rel="alternate" href="https://docs.tigerbeetle.com/about/architecture" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.tigerbeetle.com/about/architecture" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://NPDIZGXHAP-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="TigerBeetle Docs" href="/opensearch.xml">

<script src="https://plausible.io/js/script.js" defer="defer" data-domain="docs.tigerbeetle.com"></script><link rel="stylesheet" href="/assets/css/styles.f6ff8e1d.css">
<link rel="preload" href="/assets/js/runtime~main.0dce63bd.js" as="script">
<link rel="preload" href="/assets/js/main.5e0f8ced.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="TigerBeetle Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo-white.svg" alt="TigerBeetle Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">TigerBeetle Docs</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tigerbeetle/tigerbeetle" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">TigerBeetle Docs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/quick-start">Quick Start</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/coding/">Coding</a><button aria-label="Toggle the collapsible sidebar category &#x27;Coding&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/operating/deploy">Operating</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/clients/dotnet">Client Libraries</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/reference/account">Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/about/">About</a><button aria-label="Toggle the collapsible sidebar category &#x27;About&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/oltp">Built for OLTP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/performance">Performance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/safety">Safety</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/vopr">Deterministic Simulation Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/about/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/production-ready">Production Ready</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/zig">Zig</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/about/internals/">Internals</a><button aria-label="Toggle the collapsible sidebar category &#x27;Internals&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/about/"><span itemprop="name">About</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Architecture</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Architecture</h1><p>In theory, TigerBeetle is a replicated state machine that <strong>takes an initial starting state</strong>
(account opening balances), and <strong>applies a set of input events</strong> (transfers) in deterministic
order, after first replicating these input events safely, to <strong>arrive at a final state</strong> (account
closing balances).</p><p>In practice, TigerBeetle is based on the <a href="https://www.infoq.com/presentations/LMAX/" target="_blank" rel="noopener noreferrer">LMAX Exchange
Architecture</a> and makes a few improvements.</p><p>We take the same three classic LMAX steps:</p><ol><li>journal incoming events safely to disk, and replicate to backup nodes, then</li><li>apply these events to the in-memory state, then</li><li>ACK to the client</li></ol><p>And then we introduce something new:</p><ol start="4"><li>delete the local journalling step entirely, and</li><li>replace it with parallel replication to 3/5 distributed replicas.</li></ol><p>Our architecture then becomes three easy steps:</p><ol><li>replicate incoming events safely to a quorum of distributed replicas, then</li><li>apply these events to the in-memory state, then</li><li>ACK to the client</li></ol><p>That&#x27;s how TigerBeetle <strong>eliminates gray failure in the leader&#x27;s local disk</strong>, and how TigerBeetle
<strong>eliminates gray failure in the network links to the replication nodes</strong>.</p><p>Like LMAX, TigerBeetle uses a thread-per-core design for optimal performance, with strict
single-threading to enforce the single-writer principle and to avoid the costs of multi-threaded
coordinated access to data.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-structures">Data Structures<a href="#data-structures" class="hash-link" aria-label="Direct link to Data Structures" title="Direct link to Data Structures">‚Äã</a></h2><p>The best way to understand TigerBeetle is through the data structures it provides. All data
structures are <strong>fixed-size</strong> for performance and simplicity, and there are two main kinds of data
structures, <strong>events</strong> and <strong>states</strong>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="events">Events<a href="#events" class="hash-link" aria-label="Direct link to Events" title="Direct link to Events">‚Äã</a></h3><p>Events are <strong>immutable data structures</strong> that <strong>instantiate or mutate state data structures</strong>:</p><ul><li>Events cannot be changed, not even by other events.</li><li>Events cannot be derived and must therefore be recorded before execution.</li><li>Events must be executed one after another ‚Äìin deterministic order‚Äì to ensure replayability.</li><li>Events may depend on past events (should they choose).</li><li>Events cannot depend on future events.</li><li>Events may depend on states being at an exact version (should they choose).</li><li>Events may succeed or fail, but the result of an event is never stored in the event; it is stored
in the state instantiated or mutated by the event.</li><li>Events can only have one immutable version, which can be referenced directly by the event&#x27;s id.</li><li>Events should be retained for auditing purposes. However, events may be drained into a separate
cold storage system once their effect has been captured in a state snapshot to compact the journal
and improve startup times.</li></ul><p><strong>create_transfer</strong>: Create a transfer between accounts (maps to a &quot;prepare&quot;). We group fields in
descending order of size to avoid unnecessary struct padding in C implementations.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">          create_transfer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      id: 16 bytes (128-bit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        debit_account_id: 16 bytes (128-bit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       credit_account_id: 16 bytes (128-bit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  amount: 16 bytes (128-bit) [required, an unsigned integer in the unit of value of the debit and credit accounts, which must be the same for both accounts]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              pending_id: 16 bytes (128-bit) [optional, required to post or void an existing but pending transfer]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           user_data_128: 16 bytes (128-bit) [optional, e.g. opaque third-party identifier to link this transfer (many-to-one) to an external entity]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            user_data_64:  8 bytes ( 64-bit) [optional, e.g. opaque third-party identifier to link this transfer (many-to-one) to an external entity]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            user_data_32:  4 bytes ( 32-bit) [optional, e.g. opaque third-party identifier to link this transfer (many-to-one) to an external entity]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 timeout:  4 bytes ( 32-bit) [optional, required only for a pending transfer, a quantity of time, i.e. an offset in seconds from timestamp]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  ledger:  4 bytes ( 32-bit) [required, to enforce isolation by ensuring that all transfers are between accounts of the same ledger]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    code:  2 bytes ( 16-bit) [required, an opaque chart of accounts code describing the reason for the transfer, e.g. deposit, settlement]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   flags:  2 bytes ( 16-bit) [optional, to modify the usage of the reserved field and for future feature expansion]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               timestamp:  8 bytes ( 64-bit) [reserved, assigned by the leader before journalling]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} = 128 bytes (2 CPU cache lines)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>create_account</strong>: Create an account.</p><ul><li>We use the terms <code>credit</code> and <code>debit</code> instead of &quot;payable&quot; or &quot;receivable&quot; since the meaning of a
credit balance depends on whether the account is an asset or liability or equity, income or
expense.</li><li>A <code>posted</code> amount refers to an amount posted by a transfer.</li><li>A <code>pending</code> amount refers to an inflight amount yet-to-be-posted by a two-phase transfer only,
where the transfer is still pending, and the transfer timeout has not yet fired. In other words,
the transfer amount has been reserved in the pending account balance (to avoid double-spending)
but not yet posted to the posted balance. The reserved amount will rollback if the transfer
ultimately fails. By default, transfers post automatically, but being able to reserve the amount
as pending and then post the amount only later can sometimes be convenient, for example, when
switching credit card payments.</li><li>The debit balance of an account is given by adding <code>debits_posted</code> plus <code>debits_pending</code>,
likewise, for the credit balance of an account.</li><li>The total balance of an account can be derived by subtracting the total credit balance from the
total debit balance.</li><li>We keep both sides of the ledger (debit and credit) separate to avoid having to deal with signed
numbers and to preserve more information about the nature of an account. For example, two accounts
could have the same balance of 0, but one account could have 1,000,000 units on both sides of the
ledger, whereas another account could have 1 unit on both sides, both balancing out to 0.</li><li>Once created, an account may be changed only through transfer events to keep an immutable paper
trail for auditing.</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">           create_account {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      id: 16 bytes (128-bit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          debits_pending: 16 bytes (128-bit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           debits_posted: 16 bytes (128-bit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         credits_pending: 16 bytes (128-bit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          credits_posted: 16 bytes (128-bit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           user_data_128: 16 bytes (128-bit) [optional, opaque third-party identifier to link this account (many-to-one) to an external entity]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            user_data_64:  8 bytes ( 64-bit) [optional, opaque third-party identifier to link this account (many-to-one) to an external entity]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            user_data_32:  4 bytes ( 32-bit) [optional, opaque third-party identifier to link this account (many-to-one) to an external entity]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                reserved:  4 bytes ( 32-bit) [reserved for future accounting policy primitives]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  ledger:  4 bytes ( 32-bit) [required, to enforce isolation by ensuring that all transfers are between accounts of the same ledger]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    code:  2 bytes ( 16-bit) [required, an opaque chart of accounts code describing the reason for the transfer, e.g. deposit, settlement]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   flags:  2 bytes ( 16-bit) [optional, net balance limits: e.g. debits_must_not_exceed_credits or credits_must_not_exceed_debits]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               timestamp:  8 bytes ( 64-bit) [reserved]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} = 128 bytes (2 CPU cache lines)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="states">States<a href="#states" class="hash-link" aria-label="Direct link to States" title="Direct link to States">‚Äã</a></h3><p>States are <strong>data structures</strong> that capture the results of events:</p><ul><li>States can always be derived by replaying all events.</li></ul><p>TigerBeetle provides <strong>exactly one state data structure</strong>:</p><ul><li><strong>Account</strong>: An account showing the effect of all transfers.</li></ul><p>To simplify, to reduce memory copies and to reuse the wire format of event data structures as much
as possible, we reuse our <code>create_account</code> event data structure to instantiate the corresponding
state data structure.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol">Protocol<a href="#protocol" class="hash-link" aria-label="Direct link to Protocol" title="Direct link to Protocol">‚Äã</a></h2><p>The current TCP wire protocol is:</p><ul><li>a fixed-size header that can be used for requests or responses,</li><li>followed by variable-length data.</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HEADER (128 bytes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16 bytes CHECKSUM (of remaining HEADER)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16 bytes CHECKSUM BODY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...see src/vsr.zig for the rest of the Header definition...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DATA (multiples of 64 bytes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">................................................................................</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">................................................................................</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">................................................................................</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>DATA</code> in <strong>the request</strong> for a <code>create_transfer</code> command looks like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{ create_transfer event struct }, { create_transfer event struct } etc.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>All event structures are appended one after the other in the <code>DATA</code>.</li></ul><p>The <code>DATA</code> in <strong>the response</strong> to a <code>create_transfer</code> command looks like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{ index: integer, error: integer }, { index: integer, error: integer }, etc.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Only failed <code>create_transfer</code> events emit an <code>error</code> struct in the response. We do this to
optimize the common case where most <code>create_transfer</code> events succeed.</li><li>The <code>error</code> struct includes the <code>index</code> into the batch of the <code>create_transfer</code> event that failed
and a TigerBeetle <code>error</code> return code indicating why.</li><li>All other <code>create_transfer</code> events succeeded.</li><li>This <code>error</code> struct response strategy is the same for <code>create_account</code> events.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="protocol-design-decisions">Protocol Design Decisions<a href="#protocol-design-decisions" class="hash-link" aria-label="Direct link to Protocol Design Decisions" title="Direct link to Protocol Design Decisions">‚Äã</a></h3><p>The header is a multiple of 128 bytes because we want to keep the subsequent data aligned to 64-byte
cache line boundaries. We don&#x27;t want any structure to straddle multiple cache lines unnecessarily
for the sake of simplicity with respect to struct alignment and because this can have a performance
impact through false sharing.</p><p>We order the header struct as we do to keep any C protocol implementations padding-free.</p><p>We use AEGIS-128L as our checksum, designed to fully exploit the parallelism and built-in AES
support of recent Intel and ARM CPUs.</p><p>The reason we use two checksums instead of only a single checksum across header and data is that we
need a reliable way to know the size of the data to expect before we start receiving the data.</p><p>Here is an example showing the risk of a single checksum for the recipient:</p><ol><li>We receive a header with a single checksum protecting both header and data.</li><li>We extract the SIZE of the data from the header (4 GiB in this case).</li><li>We cannot tell if this SIZE value is corrupt until we receive the data.</li><li>We wait for 4 GiB of data to arrive before calculating/comparing checksums.</li><li>Except the SIZE was corrupted in transit from 16 MiB to 4 GiB (2-bit flips).</li><li>We never detect the corruption, the connection times out, and we miss our SLA.</li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/tigerbeetle/tigerbeetle/blob/main/docs/about/architecture.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/about/vopr"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Deterministic Simulation Testing</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/about/production-ready"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Production Ready</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#data-structures" class="table-of-contents__link toc-highlight">Data Structures</a><ul><li><a href="#events" class="table-of-contents__link toc-highlight">Events</a></li><li><a href="#states" class="table-of-contents__link toc-highlight">States</a></li></ul></li><li><a href="#protocol" class="table-of-contents__link toc-highlight">Protocol</a><ul><li><a href="#protocol-design-decisions" class="table-of-contents__link toc-highlight">Protocol Design Decisions</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a href="https://github.com/tigerbeetle/tigerbeetle" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">¬∑</span><a href="https://slack.tigerbeetle.com/invite" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">¬∑</span><a href="https://mailchi.mp/8e9fa0f36056/subscribe-to-tigerbeetle" target="_blank" rel="noopener noreferrer" class="footer__link-item">Newsletter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">¬∑</span><a href="https://twitter.com/tigerbeetledb" target="_blank" rel="noopener noreferrer" class="footer__link-item">ùïè<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">¬∑</span><a href="https://linkedin.com/company/tigerbeetle" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">¬∑</span><a href="https://www.youtube.com/@tigerbeetledb" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://tigerbeetle.com/" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/logo-with-text-white.svg" alt="TigerBeetle Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/logo-with-text-white.svg" alt="TigerBeetle Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">Copyright ¬© 2024 TigerBeetle, Inc. All rights reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0dce63bd.js"></script>
<script src="/assets/js/main.5e0f8ced.js"></script>
</body>
</html>