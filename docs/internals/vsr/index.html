<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-internals/vsr">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">VSR | TigerBeetle Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.tigerbeetle.com/internals/vsr"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="VSR | TigerBeetle Docs"><meta data-rh="true" name="description" content="Documentation for (roughly) code in the src/vsr directory."><meta data-rh="true" property="og:description" content="Documentation for (roughly) code in the src/vsr directory."><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://docs.tigerbeetle.com/internals/vsr"><link data-rh="true" rel="alternate" href="https://docs.tigerbeetle.com/internals/vsr" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.tigerbeetle.com/internals/vsr" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://NPDIZGXHAP-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="TigerBeetle Docs" href="/opensearch.xml">

<script src="https://plausible.io/js/script.js" defer="defer" data-domain="docs.tigerbeetle.com"></script><link rel="stylesheet" href="/assets/css/styles.6ee9f562.css">
<link rel="preload" href="/assets/js/runtime~main.a2689e27.js" as="script">
<link rel="preload" href="/assets/js/main.476d745f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="TigerBeetle Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="TigerBeetle Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">TigerBeetle Docs</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tigerbeetledb/tigerbeetle" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">TigerBeetle Docs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/quick-start/">Quick Start</a><button aria-label="Toggle the collapsible sidebar category &#x27;Quick Start&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/design/client-requests">Design</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/deploy/hardware">Deploy</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/recipes/close-account">Recipes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/clients/dotnet">Client Libraries</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/reference/accounts">Reference</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/FAQ">FAQ</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/internals/">Internals</a><button aria-label="Toggle the collapsible sidebar category &#x27;Internals&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/internals/vsr">VSR</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/internals/lsm">LSM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/internals/sync">State Sync</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/internals/testing">Testing</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/internals/"><span itemprop="name">Internals</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">VSR</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>VSR</h1><p>Documentation for (roughly) code in the <code>src/vsr</code> directory.</p><h1>Glossary</h1><p>Consensus:</p><ul><li><em>checkpoint</em>: Ensure that all updates from the past wrap of the WAL are durable in the <em>grid</em>, then advance the replica&#x27;s recovery point by updating the superblock. After a checkpoint, the checkpointed WAL entries are safe to be overwritten by the next wrap. (Sidenote: in consensus literature this is sometimes called snapshotting. But we use that term to mean something else.)</li><li><em>header</em>: Identifier for many kinds of messages, including each entry in the VSR log. Passed around instead of the entry when the full entry is not needed (such as view change).</li><li><em>journal</em>: The in-memory data structure that manages the WAL.</li><li><em>nack</em>: Short for negative acknowledgement. Used to determine (during a view change) which entries can be truncated from the log. See <a href="https://www.usenix.org/system/files/conference/fast18/fast18-alagappan.pdf" target="_blank" rel="noopener noreferrer">Protocol Aware Recovery</a>.</li><li><em>op</em>: Short for op-number. An op is assigned to each request that is submitted by the user before being stored in the log. An op is a monotonically increasing integer identifying each message to be handled by consensus. When messages with the same op in different views conflict, view change picks one version to commit. Each user batch (which may contain many batch entries) corresponds to one op. Each op is identified (once inside the VSR log) by a <em>header</em>.</li><li><em>superblock</em>: All local state for the replica that cannot be replicated remotely. Loss is protected against by storing <code>config.superblock_copies</code> copies of the superblock.</li><li><em>view</em>: A replica is <em>primary</em> for one view. Views are monotonically increasing integers that are incremented each time a new primary is selected.</li></ul><p>Storage:</p><ul><li><em>zone</em>: The TigerBeetle data file is made up of zones. The superblock is one zone.</li><li><em>grid</em>: The zone on disk where LSM trees and metadata for them reside.</li><li><em>WAL</em>: Write-ahead log. It is implemented as two on-disk ring buffers. Entries are only overwritten after they have been checkpointed.</li><li><em>state sync</em>: The process of syncing checkpointed data (the <em>grid</em>, the superblock manifest, and the superblock freeset). When a replica lags behind the cluster far enough that their WALs no longer intersect, the lagging replica must state sync to catch up.</li></ul><h1>Protocols</h1><h3 class="anchor anchorWithStickyNavbar_LWe7" id="commands">Commands<a href="#commands" class="hash-link" aria-label="Direct link to Commands" title="Direct link to Commands">​</a></h3><table><thead><tr><th align="right"><code>vsr.Header.Command</code></th><th align="right">Source</th><th align="right">Target</th><th>Protocols</th></tr></thead><tbody><tr><td align="right"><code>ping</code></td><td align="right">replica</td><td align="right">replica</td><td><a href="#protocol-ping-replica-replica">Ping (Replica-Replica)</a></td></tr><tr><td align="right"><code>pong</code></td><td align="right">replica</td><td align="right">replica</td><td><a href="#protocol-ping-replica-replica">Ping (Replica-Replica)</a></td></tr><tr><td align="right"><code>ping_client</code></td><td align="right">client</td><td align="right">replica</td><td><a href="#protocol-ping-replica-client">Ping (Replica-Client)</a></td></tr><tr><td align="right"><code>pong_client</code></td><td align="right">replica</td><td align="right">client</td><td><a href="#protocol-ping-replica-client">Ping (Replica-Client)</a></td></tr><tr><td align="right"><code>request</code></td><td align="right">client</td><td align="right">primary</td><td><a href="#protocol-normal">Normal</a></td></tr><tr><td align="right"><code>prepare</code></td><td align="right">replica</td><td align="right">backup</td><td><a href="#protocol-normal">Normal</a>, <a href="#protocol-repair-wal">Repair WAL</a></td></tr><tr><td align="right"><code>prepare_ok</code></td><td align="right">replica</td><td align="right">primary</td><td><a href="#protocol-normal">Normal</a>, <a href="#protocol-repair-wal">Repair WAL</a></td></tr><tr><td align="right"><code>reply</code></td><td align="right">primary</td><td align="right">client</td><td><a href="#protocol-normal">Normal</a>, <a href="#protocol-repair-client-table">Repair Client Table</a></td></tr><tr><td align="right"><code>commit</code></td><td align="right">primary</td><td align="right">backup</td><td><a href="#protocol-normal">Normal</a></td></tr><tr><td align="right"><code>start_view_change</code></td><td align="right">replica</td><td align="right">all replicas</td><td><a href="#protocol-start-view-change">Start-View-Change</a></td></tr><tr><td align="right"><code>do_view_change</code></td><td align="right">replica</td><td align="right">all replicas</td><td><a href="#protocol-view-change">View-Change</a></td></tr><tr><td align="right"><code>start_view</code></td><td align="right">primary</td><td align="right">backup</td><td><a href="#protocol-requeststart-view">Request/Start View</a></td></tr><tr><td align="right"><code>request_start_view</code></td><td align="right">backup</td><td align="right">primary</td><td><a href="#protocol-requeststart-view">Request/Start View</a></td></tr><tr><td align="right"><code>request_headers</code></td><td align="right">replica</td><td align="right">replica</td><td><a href="#protocol-repair-journal">Repair Journal</a></td></tr><tr><td align="right"><code>request_prepare</code></td><td align="right">replica</td><td align="right">replica</td><td><a href="#protocol-repair-wal">Repair WAL</a></td></tr><tr><td align="right"><code>request_reply</code></td><td align="right">replica</td><td align="right">replica</td><td><a href="#protocol-repair-client-table">Repair Client Table</a></td></tr><tr><td align="right"><code>headers</code></td><td align="right">replica</td><td align="right">replica</td><td><a href="#protocol-repair-journal">Repair Journal</a></td></tr><tr><td align="right"><code>eviction</code></td><td align="right">primary</td><td align="right">client</td><td><a href="#protocol-client">Client</a></td></tr><tr><td align="right"><code>request_blocks</code></td><td align="right">replica</td><td align="right">replica</td><td><a href="#protocol-state-sync">State Sync</a>, <a href="#protocol-repair-grid">Repair Grid</a></td></tr><tr><td align="right"><code>block</code></td><td align="right">replica</td><td align="right">replica</td><td><a href="#protocol-state-sync">State Sync</a>, <a href="#protocol-repair-grid">Repair Grid</a></td></tr><tr><td align="right"><code>request_sync_manifest</code></td><td align="right">replica</td><td align="right">replica</td><td><a href="#protocol-state-sync">State Sync</a></td></tr><tr><td align="right"><code>request_sync_free_set</code></td><td align="right">replica</td><td align="right">replica</td><td><a href="#protocol-state-sync">State Sync</a></td></tr><tr><td align="right"><code>request_sync_client_sessions</code></td><td align="right">replica</td><td align="right">replica</td><td><a href="#protocol-state-sync">State Sync</a></td></tr><tr><td align="right"><code>sync_manifest</code></td><td align="right">replica</td><td align="right">replica</td><td><a href="#protocol-state-sync">State Sync</a></td></tr><tr><td align="right"><code>sync_free_set</code></td><td align="right">replica</td><td align="right">replica</td><td><a href="#protocol-state-sync">State Sync</a></td></tr><tr><td align="right"><code>sync_client_sessions</code></td><td align="right">replica</td><td align="right">replica</td><td><a href="#protocol-state-sync">State Sync</a></td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="recovery">Recovery<a href="#recovery" class="hash-link" aria-label="Direct link to Recovery" title="Direct link to Recovery">​</a></h3><p>Unlike <a href="https://pmg.csail.mit.edu/papers/vr-revisited.pdf" target="_blank" rel="noopener noreferrer">VRR</a>, TigerBeetle does not implement Recovery Protocol (see §4.3).
Instead, replicas persist their VSR state to the superblock.
This ensures that a recovering replica never backtracks to an older view (from the point of view of the cluster).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol-ping-replica-replica">Protocol: Ping (Replica-Replica)<a href="#protocol-ping-replica-replica" class="hash-link" aria-label="Direct link to Protocol: Ping (Replica-Replica)" title="Direct link to Protocol: Ping (Replica-Replica)">​</a></h2><p>Replicas send <code>command=ping</code>/<code>command=pong</code> messages to one another to synchronize clocks.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol-ping-replica-client">Protocol: Ping (Replica-Client)<a href="#protocol-ping-replica-client" class="hash-link" aria-label="Direct link to Protocol: Ping (Replica-Client)" title="Direct link to Protocol: Ping (Replica-Client)">​</a></h2><p>Clients send <code>command=ping_client</code> (and receive <code>command=pong_client</code>) messages to (from) replicas to learn the cluster&#x27;s current view.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol-normal">Protocol: Normal<a href="#protocol-normal" class="hash-link" aria-label="Direct link to Protocol: Normal" title="Direct link to Protocol: Normal">​</a></h2><p>Normal protocol prepares and commits requests (from clients) and sends replies (to clients).</p><ol><li>The client sends a <code>command=request</code> message to the primary. (If the client&#x27;s view is outdated, the receiver will forward the message on to the actual primary).</li><li>The primary converts the <code>command=request</code> to a <code>command=prepare</code> (assigning it an <code>op</code> and <code>timestamp</code>).</li><li>Each replica (in a chain beginning with the primary) performs the following steps concurrently:<ul><li>Write the prepare to the WAL.</li><li>Forward the prepare to the next replica in the chain.</li></ul></li><li>Each replica sends a <code>command=prepare_ok</code> message to the primary once it has written the prepare to the WAL.</li><li>When a primary collects a <a href="#quorums">replication quorum</a> of <code>prepare_ok</code>s <em>and</em> it has committed all preceding prepares, it commits the prepare.</li><li>The primary replies to the client.</li><li>The backups are informed that the prepare was committed by either:<ul><li>a subsequent prepare, or</li><li>a periodic <code>command=commit</code> heartbeat message.</li></ul></li></ol><p>See also:</p><ul><li><a href="https://pmg.csail.mit.edu/papers/vr-revisited.pdf" target="_blank" rel="noopener noreferrer">VRR</a> §4.1</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol-start-view-change">Protocol: Start-View-Change<a href="#protocol-start-view-change" class="hash-link" aria-label="Direct link to Protocol: Start-View-Change" title="Direct link to Protocol: Start-View-Change">​</a></h2><p>Start-View-Change (SVC) protocol initiates <a href="#protocol-view-change">view-changes</a> with minimal disruption.</p><p>Unlike the Start-View-Change described in <a href="https://pmg.csail.mit.edu/papers/vr-revisited.pdf" target="_blank" rel="noopener noreferrer">VRR</a> §4.2, this protocol runs in both <code>status=normal</code> and <code>status=view_change</code> (not just <code>status=view_change</code>).</p><ol><li>Depending on the replica&#x27;s status:<ul><li><code>status=normal</code> &amp; primary: When the replica has not recently received a <code>prepare_ok</code> (and it has a prepare in flight), pause broadcasting <code>command=commit</code>.</li><li><code>status=normal</code> &amp; backup: When the replica has not recently received a <code>command=commit</code>, broadcast <code>command=start_view_change</code> to all replicas (including self).</li><li><code>status=view_change</code>: If the replica has not completed a view-change recently, send a <code>command=start_view_change</code> to all replicas (including self).</li></ul></li><li>(Periodically retry sending the SVC).</li><li>If the backup receives a <code>command=commit</code> or changes views (respectively), stop the <code>command=start_view_change</code> retries.</li><li>If the replica collects a <a href="#quorums">view-change quorum</a> of SVC messages, transition to <code>status=view_change</code> for the next view. (That is, increment the replica&#x27;s view and start sending a DVC).</li></ol><p>This protocol approach enables liveness under asymmetric network partitions. For example, a replica which can send to the cluster but not receive may send SVCs, but if the remainder of the cluster is healthy, they will never achieve a quorum, so the view is stable. When the partition heals, the formerly-isolated replica may rejoin the original view (if it was isolated in <code>status=normal</code>) or a new view (if it was isolated in <code>status=view_change</code>).</p><p>See also:</p><ul><li><a href="https://decentralizedthoughts.github.io/2020-12-12-raft-liveness-full-omission/" target="_blank" rel="noopener noreferrer">Raft does not Guarantee Liveness in the face of Network Faults</a> (&quot;PreVote and CheckQuorum&quot;)</li><li><a href="https://web.stanford.edu/~ouster/cgi-bin/papers/OngaroPhD.pdf" target="_blank" rel="noopener noreferrer">&quot;Consensus: Bridging Theory and Practice&quot;</a> §6.2 &quot;Leaders&quot; describes periodically committing a heartbeat to detect stale leaders.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol-view-change">Protocol: View-Change<a href="#protocol-view-change" class="hash-link" aria-label="Direct link to Protocol: View-Change" title="Direct link to Protocol: View-Change">​</a></h2><p>A replica sends <code>command=do_view_change</code> to all replicas, with the <code>view</code> it is attempting to start.</p><ul><li>The <em>primary</em> of the <code>view</code> collects a <a href="#quorums">view-change quorum</a> of DVCs.</li><li>The <em>backup</em> of the <code>view</code> uses to <code>do_view_change</code> to updates its current <code>view</code> (transitioning to <code>status=view_change</code>).</li></ul><p>DVCs include headers from prepares which are:</p><ul><li><em>present</em>: A valid header, corresponding to a valid prepare in the replica&#x27;s WAL.</li><li><em>missing</em>: A valid header, corresponding to a prepare that the replica has not prepared/acked.</li><li><em>corrupt</em>: A valid header, corresponding to a corrupt prepare in the replica&#x27;s WAL.</li><li><em>blank</em>: A placeholder (fake) header, corresponding to a header that the replica has never seen.</li><li><em>fault</em>: A placeholder (fake) header, corresponding to a header that the replica <em>may have</em> prepared/acked.</li></ul><p>If the new primary collects a <em>nack quorum</em> of <em>blank</em> headers for a particular possibly-uncommitted op, it truncates the log.</p><p>These cases are farther distinguished during <a href="#protocol-repair-wal">WAL repair</a>.</p><p>When the primary collects its DVC quorum:</p><ol><li>If any DVC in the quorum is ahead of the primary by more than one checkpoint,
the new primary &quot;forfeits&quot; (that is, it immediately triggers another view change).</li><li>If any DVC in the quorum is ahead of the primary by more than one checkpoint,
and any messages in the next checkpoint are possibly committed,
the new primary forfeits.</li><li>The primary installs the headers to its suffix.</li><li>Then the primary repairs its headers. (<a href="#protocol-repair-journal">Protocol: Repair Journal</a>).</li><li>Then the primary repairs its prepares. (<a href="#protocol-repair-wal">Protocol: Repair WAL</a>) (and potentially truncates uncommitted ops).</li><li>Then primary commits all prepares which are not known to be uncommitted.</li><li>Then the primary transitions to <code>status=normal</code> and broadcasts a <code>command=start_view</code>.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol-requeststart-view">Protocol: Request/Start View<a href="#protocol-requeststart-view" class="hash-link" aria-label="Direct link to Protocol: Request/Start View" title="Direct link to Protocol: Request/Start View">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="request_start_view"><code>request_start_view</code><a href="#request_start_view" class="hash-link" aria-label="Direct link to request_start_view" title="Direct link to request_start_view">​</a></h3><p>A backup sends a <code>command=request_start_view</code> to the primary of a view when any of the following occur:</p><ul><li>the backup learns about a newer view via a <code>command=commit</code> message, or</li><li>the backup learns about a newer view via a <code>command=prepare</code> message, or</li><li>the backup discovers <code>commit_max</code> exceeds <code>min(op_head, op_checkpoint_trigger)</code> (during repair), or</li><li>a replica recovers to <code>status=recovering_head</code></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="start_view"><code>start_view</code><a href="#start_view" class="hash-link" aria-label="Direct link to start_view" title="Direct link to start_view">​</a></h3><p>When a <code>status=normal</code> primary receives <code>command=request_start_view</code>, it replies with a <code>command=start_view</code>.
<code>command=start_view</code> includes the view&#x27;s current suffix — the headers of the latest messages in the view.</p><p>Upon receiving a <code>start_view</code> for the new view, the backup installs the suffix, transitions to <code>status=normal</code>, and begins repair.</p><p>A <code>start_view</code> contains the following headers (which may overlap):</p><ul><li>The suffix: <code>pipeline_prepare_queue_max</code> headers from the head op down.</li><li>The &quot;hooks&quot;: the header of any previous checkpoint triggers within our repairable range.
This helps a lagging replica catch up. (There are at most 2).</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol-repair-journal">Protocol: Repair Journal<a href="#protocol-repair-journal" class="hash-link" aria-label="Direct link to Protocol: Repair Journal" title="Direct link to Protocol: Repair Journal">​</a></h2><p><code>request_headers</code> and <code>headers</code> repair gaps or breaks in a replica&#x27;s journal headers.
Repaired headers are a prerequisite for <a href="#protocol-repair-wal">repairing prepares</a>.</p><p>Because the headers are repaired backwards (from the head) by hash-chaining, it is safe for both backups and transitioning primaries.</p><p>Gaps/breaks in a replica&#x27;s journal headers may occur:</p><ul><li>On a backup, receiving nonconsecutive ops, leaving a gap in its headers.</li><li>On a backup, which has not finished repair.</li><li>On a new primary during a view-change, which has not finished repair.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol-repair-wal">Protocol: Repair WAL<a href="#protocol-repair-wal" class="hash-link" aria-label="Direct link to Protocol: Repair WAL" title="Direct link to Protocol: Repair WAL">​</a></h2><p>The replica&#x27;s journal tracks which prepares the WAL requires — i.e. headers for which either:</p><ul><li>no prepare was ever received, or</li><li>the prepare was received and written, but was since discovered to be corrupt</li></ul><p>During repair, missing/damaged prepares are requested &amp; repaired chronologically, which:</p><ul><li>improves the chances that older entries will be available, i.e. not yet overwritten</li><li>enables better pipelining of repair and commit.</li></ul><p>In response to a <code>request_prepare</code>:</p><ul><li>Reply the <code>command=prepare</code> with the requested prepare, if available and valid.</li><li>Otherwise do not reply. (e.g. the corresponding slot in the WAL is corrupt)</li></ul><p>Per <a href="https://www.usenix.org/system/files/conference/fast18/fast18-alagappan.pdf" target="_blank" rel="noopener noreferrer">PAR&#x27;s CTRL Protocol</a>, we do not nack corrupt entries, since they <em>might</em> be the prepare being requested.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol-repair-client-table">Protocol: Repair Client Table<a href="#protocol-repair-client-table" class="hash-link" aria-label="Direct link to Protocol: Repair Client Table" title="Direct link to Protocol: Repair Client Table">​</a></h2><p>The replica&#x27;s client table stores the latest reply to each active client.</p><p>During repair, corrupt replies are requested &amp; repaired.</p><p>In response to a <code>request_reply</code>:</p><ul><li>Respond with the <code>command=reply</code> (the requested reply), if available and valid.</li><li>Otherwise do not reply.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol-client">Protocol: Client<a href="#protocol-client" class="hash-link" aria-label="Direct link to Protocol: Client" title="Direct link to Protocol: Client">​</a></h2><ol><li>Client sends <code>command=request operation=register</code> to registers with the cluster by starting a new request-reply hashchain. (See also: <a href="#protocol-normal">Protocol: Normal</a>).</li><li>Client receives <code>command=reply operation=register</code> from the cluster. (If the cluster is at the maximum number of clients, it evicts the oldest).</li><li>Repeat:<ol><li>Send <code>command=request</code> to cluster.</li><li>If the client has been evicted, receive <code>command=eviction</code> from the cluster. (The client must re-register before sending more requests.)</li><li>If the client has not been evicted, receive <code>command=reply</code> from cluster.</li></ol></li></ol><p>See also:</p><ul><li><a href="/design/client-sessions#lifecycle">Integration: Client Session Lifecycle</a></li><li><a href="/design/client-sessions#eviction">Integration: Client Session Eviction</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol-repair-grid">Protocol: Repair Grid<a href="#protocol-repair-grid" class="hash-link" aria-label="Direct link to Protocol: Repair Grid" title="Direct link to Protocol: Repair Grid">​</a></h2><p>Grid repair is triggered when a replica discovers a corrupt (or missing) grid block.</p><ol><li>The repairing replica sends a <code>command=request_blocks</code> to any other replica. The message body contains a list of block <code>address</code>/<code>checksum</code>s.</li><li>Upon receiving a <code>command=request_blocks</code>, a replica reads its own grid to check for the requested blocks. For each matching block found, reply with the <code>command=block</code> message (the block itself).</li><li>Upon receiving a <code>command=block</code>, a replica writes the block to its grid, and resolves the reads that were blocked on it.</li></ol><p>Note that <em>both sides</em> of grid repair can run while the grid is being opened during replica startup.
That is, a replica can help other replicas repair and repair itself simultaneously.</p><p>TODO Describe state sync fallback.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol-state-sync">Protocol: State Sync<a href="#protocol-state-sync" class="hash-link" aria-label="Direct link to Protocol: State Sync" title="Direct link to Protocol: State Sync">​</a></h2><p>State sync synchronizes the state of a lagging/divergent replica with the healthy cluster.</p><p>State sync is used when when a lagging replica&#x27;s log no longer intersects with the cluster&#x27;s current log —
<a href="#protocol-repair-wal">WAL repair</a> cannot catch the replica up.</p><p>See <a href="/internals/sync">State Sync</a> for details.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol-reconfiguration">Protocol: Reconfiguration<a href="#protocol-reconfiguration" class="hash-link" aria-label="Direct link to Protocol: Reconfiguration" title="Direct link to Protocol: Reconfiguration">​</a></h2><p>TODO (Unimplemented)</p><h1>Quorums</h1><ul><li>The <em>replication quorum</em> is the minimum number of replicas required to complete a commit.</li><li>The <em>view-change quorum</em> is the minimum number of replicas required to complete a view-change.</li><li>The <em>nack quorum</em> is the minimum number of unique nacks required to truncate an uncommitted op.</li></ul><p>With the default configuration:</p><table><thead><tr><th align="right"><strong>Replica Count</strong></th><th align="right">1</th><th align="right">2</th><th align="right">3</th><th align="right">4</th><th align="right">5</th><th align="right">6</th></tr></thead><tbody><tr><td align="right"><strong>Replication Quorum</strong></td><td align="right">1</td><td align="right">2</td><td align="right">2</td><td align="right">2</td><td align="right">3</td><td align="right">3</td></tr><tr><td align="right"><strong>View-Change Quorum</strong></td><td align="right">1</td><td align="right">2</td><td align="right">2</td><td align="right">3</td><td align="right">3</td><td align="right">4</td></tr><tr><td align="right"><strong>Nack Quorum</strong></td><td align="right">1</td><td align="right"><strong>1</strong></td><td align="right">2</td><td align="right">3</td><td align="right">3</td><td align="right">4</td></tr></tbody></table><p>See also:</p><ul><li><code>constants.quorum_replication_max</code> for configuration.</li><li><a href="https://fpaxos.github.io/" target="_blank" rel="noopener noreferrer">Flexible Paxos</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-reading">Further reading<a href="#further-reading" class="hash-link" aria-label="Direct link to Further reading" title="Direct link to Further reading">​</a></h2><ul><li><a href="https://pmg.csail.mit.edu/papers/vr-revisited.pdf" target="_blank" rel="noopener noreferrer">Viewstamped Replication Revisited</a></li><li><a href="https://www.usenix.org/system/files/conference/fast18/fast18-alagappan.pdf" target="_blank" rel="noopener noreferrer">Protocol Aware Recovery</a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/tigerbeetledb/tigerbeetle/blob/main/docs/internals/vsr.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/internals/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Internals</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/internals/lsm"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">LSM</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#commands" class="table-of-contents__link toc-highlight">Commands</a></li><li><a href="#recovery" class="table-of-contents__link toc-highlight">Recovery</a></li><li><a href="#protocol-ping-replica-replica" class="table-of-contents__link toc-highlight">Protocol: Ping (Replica-Replica)</a></li><li><a href="#protocol-ping-replica-client" class="table-of-contents__link toc-highlight">Protocol: Ping (Replica-Client)</a></li><li><a href="#protocol-normal" class="table-of-contents__link toc-highlight">Protocol: Normal</a></li><li><a href="#protocol-start-view-change" class="table-of-contents__link toc-highlight">Protocol: Start-View-Change</a></li><li><a href="#protocol-view-change" class="table-of-contents__link toc-highlight">Protocol: View-Change</a></li><li><a href="#protocol-requeststart-view" class="table-of-contents__link toc-highlight">Protocol: Request/Start View</a><ul><li><a href="#request_start_view" class="table-of-contents__link toc-highlight"><code>request_start_view</code></a></li><li><a href="#start_view" class="table-of-contents__link toc-highlight"><code>start_view</code></a></li></ul></li><li><a href="#protocol-repair-journal" class="table-of-contents__link toc-highlight">Protocol: Repair Journal</a></li><li><a href="#protocol-repair-wal" class="table-of-contents__link toc-highlight">Protocol: Repair WAL</a></li><li><a href="#protocol-repair-client-table" class="table-of-contents__link toc-highlight">Protocol: Repair Client Table</a></li><li><a href="#protocol-client" class="table-of-contents__link toc-highlight">Protocol: Client</a></li><li><a href="#protocol-repair-grid" class="table-of-contents__link toc-highlight">Protocol: Repair Grid</a></li><li><a href="#protocol-state-sync" class="table-of-contents__link toc-highlight">Protocol: State Sync</a></li><li><a href="#protocol-reconfiguration" class="table-of-contents__link toc-highlight">Protocol: Reconfiguration</a></li><li><a href="#further-reading" class="table-of-contents__link toc-highlight">Further reading</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/tigerbeetledb" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/tigerbeetledb/tigerbeetle" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://linkedin.com/company/tigerbeetle" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/uWCGp46uG5" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 TigerBeetle, Inc. All rights reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a2689e27.js"></script>
<script src="/assets/js/main.476d745f.js"></script>
</body>
</html>