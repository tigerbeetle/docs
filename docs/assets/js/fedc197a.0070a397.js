"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[298],{3905:(e,t,a)=>{a.d(t,{Zo:()=>s,kt:()=>k});var r=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},i=Object.keys(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var p=r.createContext({}),m=function(e){var t=r.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},s=function(e){var t=m(e.components);return r.createElement(p.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,p=e.parentName,s=o(e,["components","mdxType","originalType","parentName"]),c=m(a),h=n,k=c["".concat(p,".").concat(h)]||c[h]||d[h]||i;return a?r.createElement(k,l(l({ref:t},s),{},{components:a})):r.createElement(k,l({ref:t},s))}));function k(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,l=new Array(i);l[0]=h;var o={};for(var p in t)hasOwnProperty.call(t,p)&&(o[p]=t[p]);o.originalType=e,o[c]="string"==typeof e?e:n,l[1]=o;for(var m=2;m<i;m++)l[m]=a[m];return r.createElement.apply(null,l)}return r.createElement.apply(null,a)}h.displayName="MDXCreateElement"},6222:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>m});var r=a(7462),n=(a(7294),a(3905));const i={sidebar_position:1},l="VSR",o={unversionedId:"internals/vsr",id:"internals/vsr",title:"VSR",description:"Documentation for (roughly) code in the src/vsr directory.",source:"@site/pages/internals/vsr.md",sourceDirName:"internals",slug:"/internals/vsr",permalink:"/internals/vsr",draft:!1,editUrl:"https://github.com/tigerbeetledb/tigerbeetle/blob/main/docs/internals/vsr.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Internals",permalink:"/internals/"},next:{title:"LSM",permalink:"/internals/lsm"}},p={},m=[{value:"Commands",id:"commands",level:3},{value:"Recovery",id:"recovery",level:3},{value:"Protocol: Ping (Replica-Replica)",id:"protocol-ping-replica-replica",level:2},{value:"Protocol: Ping (Replica-Client)",id:"protocol-ping-replica-client",level:2},{value:"Protocol: Normal",id:"protocol-normal",level:2},{value:"Protocol: Start-View-Change",id:"protocol-start-view-change",level:2},{value:"Protocol: View-Change",id:"protocol-view-change",level:2},{value:"Protocol: Request/Start View",id:"protocol-requeststart-view",level:2},{value:"<code>request_start_view</code>",id:"request_start_view",level:3},{value:"<code>start_view</code>",id:"start_view",level:3},{value:"Protocol: Repair Journal",id:"protocol-repair-journal",level:2},{value:"Protocol: Repair WAL",id:"protocol-repair-wal",level:2},{value:"Protocol: Repair Client Table",id:"protocol-repair-client-table",level:2},{value:"Protocol: Client",id:"protocol-client",level:2},{value:"Protocol: Repair Grid",id:"protocol-repair-grid",level:2},{value:"Protocol: Repair: State Sync",id:"protocol-repair-state-sync",level:2},{value:"Protocol: Reconfiguration",id:"protocol-reconfiguration",level:2},{value:"Further reading",id:"further-reading",level:2}],s={toc:m},c="wrapper";function d(e){let{components:t,...a}=e;return(0,n.kt)(c,(0,r.Z)({},s,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"vsr"},"VSR"),(0,n.kt)("p",null,"Documentation for (roughly) code in the ",(0,n.kt)("inlineCode",{parentName:"p"},"src/vsr")," directory."),(0,n.kt)("h1",{id:"glossary"},"Glossary"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("em",{parentName:"li"},"checkpoint"),": Ensure that all updates from the past wrap of the WAL are durable in the ",(0,n.kt)("em",{parentName:"li"},"grid"),", then advance the replica's recovery point by updating the superblock. After a checkpoint, the checkpointed WAL entries are safe to be overwritten by the next wrap. (Sidenote: in consensus literature this is sometimes called snapshotting. But we use that term to mean something else.)"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("em",{parentName:"li"},"grid"),": The zone on disk where LSM trees and metadata for them reside."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("em",{parentName:"li"},"header"),": Identifier for many kinds of messages, including each entry in the VSR log. Passed around instead of the entry when the full entry is not needed (such as view change)."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("em",{parentName:"li"},"journal"),": The in-memory data structure that manages the WAL."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("em",{parentName:"li"},"nack"),": Short for negative acknowledgement. Used to determine (during a view change) which entries can be truncated from the log. See ",(0,n.kt)("a",{parentName:"li",href:"https://www.usenix.org/system/files/conference/fast18/fast18-alagappan.pdf"},"Protocol Aware Recovery"),"."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("em",{parentName:"li"},"op"),": Short for op-number. An op is assigned to each request that is submitted by the user before being stored in the log. An op is a monotonically increasing integer identifying each message to be handled by consensus. When messages with the same op in different views conflict, view change picks one version to commit. Each user batch (which may contain many batch entries) corresponds to one op. Each op is identified (once inside the VSR log) by a ",(0,n.kt)("em",{parentName:"li"},"header"),"."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("em",{parentName:"li"},"state sync"),": The process of syncing checkpointed data (the ",(0,n.kt)("em",{parentName:"li"},"grid"),", the superblock manifest, and the superblock freeset). When a replica lags behind the cluster far enough that their WALs no longer intersect, the lagging replica must state sync to catch up."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("em",{parentName:"li"},"superblock"),": All local state for the replica that cannot be replicated remotely. Loss is protected against by storing ",(0,n.kt)("inlineCode",{parentName:"li"},"config.superblock_copies")," copies of the superblock."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("em",{parentName:"li"},"zone"),": The TigerBeetle data file is made up of zones. The superblock is one zone."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("em",{parentName:"li"},"view"),": A replica is ",(0,n.kt)("em",{parentName:"li"},"primary")," for one view. Views are monotonically increasing integers that are incremented each time a new primary is selected."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("em",{parentName:"li"},"WAL"),": Write-ahead log. It is implemented as two on-disk ring buffers. Entries are only overwritten after they have been checkpointed.")),(0,n.kt)("h1",{id:"protocols"},"Protocols"),(0,n.kt)("h3",{id:"commands"},"Commands"),(0,n.kt)("table",null,(0,n.kt)("thead",{parentName:"table"},(0,n.kt)("tr",{parentName:"thead"},(0,n.kt)("th",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"th"},"vsr.Header.Command")),(0,n.kt)("th",{parentName:"tr",align:"right"},"Source"),(0,n.kt)("th",{parentName:"tr",align:"right"},"Target"),(0,n.kt)("th",{parentName:"tr",align:null},"Protocols"))),(0,n.kt)("tbody",{parentName:"table"},(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"ping")),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-ping-replica-replica"},"Ping (Replica-Replica)"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"pong")),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-ping-replica-replica"},"Ping (Replica-Replica)"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"ping_client")),(0,n.kt)("td",{parentName:"tr",align:"right"},"client"),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-ping-replica-client"},"Ping (Replica-Client)"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"pong_client")),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:"right"},"client"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-ping-replica-client"},"Ping (Replica-Client)"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"request")),(0,n.kt)("td",{parentName:"tr",align:"right"},"client"),(0,n.kt)("td",{parentName:"tr",align:"right"},"primary"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-normal"},"Normal"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"prepare")),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:"right"},"backup"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-normal"},"Normal"),", ",(0,n.kt)("a",{parentName:"td",href:"#protocol-repair-wal"},"Repair WAL"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"prepare_ok")),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:"right"},"primary"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-normal"},"Normal"),", ",(0,n.kt)("a",{parentName:"td",href:"#protocol-repair-wal"},"Repair WAL"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"reply")),(0,n.kt)("td",{parentName:"tr",align:"right"},"primary"),(0,n.kt)("td",{parentName:"tr",align:"right"},"client"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-normal"},"Normal"),", ",(0,n.kt)("a",{parentName:"td",href:"#protocol-repair-client-table"},"Repair Client Table"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"commit")),(0,n.kt)("td",{parentName:"tr",align:"right"},"primary"),(0,n.kt)("td",{parentName:"tr",align:"right"},"backup"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-normal"},"Normal"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"start_view_change")),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:"right"},"all replicas"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-start-view-change"},"Start-View-Change"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"do_view_change")),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:"right"},"all replicas"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-view-change"},"View-Change"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"start_view")),(0,n.kt)("td",{parentName:"tr",align:"right"},"primary"),(0,n.kt)("td",{parentName:"tr",align:"right"},"backup"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-requeststart-view"},"Request/Start View"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"request_start_view")),(0,n.kt)("td",{parentName:"tr",align:"right"},"backup"),(0,n.kt)("td",{parentName:"tr",align:"right"},"primary"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-requeststart-view"},"Request/Start View"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"request_headers")),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-repair-journal"},"Repair Journal"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"request_prepare")),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-repair-wal"},"Repair WAL"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"request_reply")),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-repair-client-table"},"Repair Client Table"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"headers")),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-repair-journal"},"Repair Journal"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"eviction")),(0,n.kt)("td",{parentName:"tr",align:"right"},"primary"),(0,n.kt)("td",{parentName:"tr",align:"right"},"client"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-client"},"Client"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"request_blocks")),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-repair-grid"},"Repair Grid"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("inlineCode",{parentName:"td"},"block")),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:"right"},"replica"),(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("a",{parentName:"td",href:"#protocol-repair-grid"},"Repair Grid"))))),(0,n.kt)("h3",{id:"recovery"},"Recovery"),(0,n.kt)("p",null,"Unlike ",(0,n.kt)("a",{parentName:"p",href:"https://pmg.csail.mit.edu/papers/vr-revisited.pdf"},"VRR"),", TigerBeetle does not implement Recovery Protocol (see \xa74.3).\nInstead, replicas persist their VSR state to the superblock.\nThis ensures that a recovering replica never backtracks to an older view (from the point of view of the cluster)."),(0,n.kt)("h2",{id:"protocol-ping-replica-replica"},"Protocol: Ping (Replica-Replica)"),(0,n.kt)("p",null,"Replicas send ",(0,n.kt)("inlineCode",{parentName:"p"},"command=ping"),"/",(0,n.kt)("inlineCode",{parentName:"p"},"command=pong")," messages to one another to synchronize clocks."),(0,n.kt)("h2",{id:"protocol-ping-replica-client"},"Protocol: Ping (Replica-Client)"),(0,n.kt)("p",null,"Clients send ",(0,n.kt)("inlineCode",{parentName:"p"},"command=ping_client")," (and receive ",(0,n.kt)("inlineCode",{parentName:"p"},"command=pong_client"),") messages to (from) replicas to learn the cluster's current view."),(0,n.kt)("h2",{id:"protocol-normal"},"Protocol: Normal"),(0,n.kt)("p",null,"Normal protocol prepares and commits requests (from clients) and sends replies (to clients)."),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"The client sends a ",(0,n.kt)("inlineCode",{parentName:"li"},"command=request")," message to the primary. (If the client's view is outdated, the receiver will forward the message on to the actual primary)."),(0,n.kt)("li",{parentName:"ol"},"The primary converts the ",(0,n.kt)("inlineCode",{parentName:"li"},"command=request")," to a ",(0,n.kt)("inlineCode",{parentName:"li"},"command=prepare")," (assigning it an ",(0,n.kt)("inlineCode",{parentName:"li"},"op")," and ",(0,n.kt)("inlineCode",{parentName:"li"},"timestamp"),")."),(0,n.kt)("li",{parentName:"ol"},"Each replica (in a chain beginning with the primary) performs the following steps concurrently:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"Write the prepare to the WAL."),(0,n.kt)("li",{parentName:"ul"},"Forward the prepare to the next replica in the chain."))),(0,n.kt)("li",{parentName:"ol"},"Each replica sends a ",(0,n.kt)("inlineCode",{parentName:"li"},"command=prepare_ok")," message to the primary once it has written the prepare to the WAL."),(0,n.kt)("li",{parentName:"ol"},"When a primary collects a ",(0,n.kt)("a",{parentName:"li",href:"#quorums"},"replication quorum")," of ",(0,n.kt)("inlineCode",{parentName:"li"},"prepare_ok"),"s ",(0,n.kt)("em",{parentName:"li"},"and")," it has committed all preceding prepares, it commits the prepare."),(0,n.kt)("li",{parentName:"ol"},"The primary replies to the client."),(0,n.kt)("li",{parentName:"ol"},"The backups are informed that the prepare was committed by either:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"a subsequent prepare, or"),(0,n.kt)("li",{parentName:"ul"},"a periodic ",(0,n.kt)("inlineCode",{parentName:"li"},"command=commit")," heartbeat message.")))),(0,n.kt)("mermaid",{value:"sequenceDiagram\n    participant C0 as Client\n    participant R0 as Replica 0 (primary)\n    participant R1 as Replica 1 (backup)\n    participant R2 as Replica 2 (backup)\n\n    C0->>R0: Request A\n\n    R0->>+R0: Prepare A\n    R0->>+R1: Prepare A\n    R1->>+R2: Prepare A\n\n    R0->>-R0: Prepare-Ok A\n    R1->>-R0: Prepare-Ok A\n    R0->>C0: Reply A\n    R2->>-R0: Prepare-Ok A"}),(0,n.kt)("p",null,"See also:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://pmg.csail.mit.edu/papers/vr-revisited.pdf"},"VRR")," \xa74.1")),(0,n.kt)("h2",{id:"protocol-start-view-change"},"Protocol: Start-View-Change"),(0,n.kt)("p",null,"Start-View-Change (SVC) protocol initiates ",(0,n.kt)("a",{parentName:"p",href:"#protocol-view-change"},"view-changes")," with minimal disruption."),(0,n.kt)("p",null,"Unlike the Start-View-Change described in ",(0,n.kt)("a",{parentName:"p",href:"https://pmg.csail.mit.edu/papers/vr-revisited.pdf"},"VRR")," \xa74.2, this protocol runs in both ",(0,n.kt)("inlineCode",{parentName:"p"},"status=normal")," and ",(0,n.kt)("inlineCode",{parentName:"p"},"status=view_change")," (not just ",(0,n.kt)("inlineCode",{parentName:"p"},"status=view_change"),")."),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Depending on the replica's status:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"status=normal")," & primary: When the replica has not recently received a ",(0,n.kt)("inlineCode",{parentName:"li"},"prepare_ok")," (and it has a prepare in flight), pause broadcasting ",(0,n.kt)("inlineCode",{parentName:"li"},"command=commit"),"."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"status=normal")," & backup: When the replica has not recently received a ",(0,n.kt)("inlineCode",{parentName:"li"},"command=commit"),", broadcast ",(0,n.kt)("inlineCode",{parentName:"li"},"command=start_view_change")," to all replicas (including self)."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"status=view_change"),": If the replica has not completed a view-change recently, send a ",(0,n.kt)("inlineCode",{parentName:"li"},"command=start_view_change")," to all replicas (including self)."))),(0,n.kt)("li",{parentName:"ol"},"(Periodically retry sending the SVC)."),(0,n.kt)("li",{parentName:"ol"},"If the backup receives a ",(0,n.kt)("inlineCode",{parentName:"li"},"command=commit")," or changes views (respectively), stop the ",(0,n.kt)("inlineCode",{parentName:"li"},"command=start_view_change")," retries."),(0,n.kt)("li",{parentName:"ol"},"If the replica collects a ",(0,n.kt)("a",{parentName:"li",href:"#quorums"},"view-change quorum")," of SVC messages, transition to ",(0,n.kt)("inlineCode",{parentName:"li"},"status=view_change")," for the next view. (That is, increment the replica's view and start sending a DVC).")),(0,n.kt)("p",null,"This protocol approach enables liveness under asymmetric network partitions. For example, a replica which can send to the cluster but not receive may send SVCs, but if the remainder of the cluster is healthy, they will never achieve a quorum, so the view is stable. When the partition heals, the formerly-isolated replica may rejoin the original view (if it was isolated in ",(0,n.kt)("inlineCode",{parentName:"p"},"status=normal"),") or a new view (if it was isolated in ",(0,n.kt)("inlineCode",{parentName:"p"},"status=view_change"),")."),(0,n.kt)("p",null,"See also:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://decentralizedthoughts.github.io/2020-12-12-raft-liveness-full-omission/"},"Raft does not Guarantee Liveness in the face of Network Faults"),' ("PreVote and CheckQuorum")'),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://web.stanford.edu/~ouster/cgi-bin/papers/OngaroPhD.pdf"},'"Consensus: Bridging Theory and Practice"'),' \xa76.2 "Leaders" describes periodically committing a heartbeat to detect stale leaders.')),(0,n.kt)("h2",{id:"protocol-view-change"},"Protocol: View-Change"),(0,n.kt)("p",null,"A replica sends ",(0,n.kt)("inlineCode",{parentName:"p"},"command=do_view_change")," to all replicas, with the ",(0,n.kt)("inlineCode",{parentName:"p"},"view")," it is attempting to start."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"The ",(0,n.kt)("em",{parentName:"li"},"primary")," of the ",(0,n.kt)("inlineCode",{parentName:"li"},"view")," collects a ",(0,n.kt)("a",{parentName:"li",href:"#quorums"},"view-change quorum")," of DVCs."),(0,n.kt)("li",{parentName:"ul"},"The ",(0,n.kt)("em",{parentName:"li"},"backup")," of the ",(0,n.kt)("inlineCode",{parentName:"li"},"view")," uses to ",(0,n.kt)("inlineCode",{parentName:"li"},"do_view_change")," to updates its current ",(0,n.kt)("inlineCode",{parentName:"li"},"view")," (transitioning to ",(0,n.kt)("inlineCode",{parentName:"li"},"status=view_change"),").")),(0,n.kt)("p",null,"DVCs include headers from prepares which are:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("em",{parentName:"li"},"present"),": A valid header, corresponding to a valid prepare in the replica's WAL."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("em",{parentName:"li"},"missing"),": A valid header, corresponding to a prepare that the replica has not prepared/acked."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("em",{parentName:"li"},"corrupt"),": A valid header, corresponding to a corrupt prepare in the replica's WAL."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("em",{parentName:"li"},"blank"),": A placeholder (fake) header, corresponding to a header that the replica has never seen."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("em",{parentName:"li"},"fault"),": A placeholder (fake) header, corresponding to a header that the replica ",(0,n.kt)("em",{parentName:"li"},"may have")," prepared/acked.")),(0,n.kt)("p",null,"If the new primary collects a ",(0,n.kt)("em",{parentName:"p"},"nack quorum")," of ",(0,n.kt)("em",{parentName:"p"},"blank")," headers for a particular possibly-uncommitted op, it truncates the log."),(0,n.kt)("p",null,"These cases are farther distinguished during ",(0,n.kt)("a",{parentName:"p",href:"#protocol-repair-wal"},"WAL repair"),"."),(0,n.kt)("p",null,"When the primary collects its DVC quorum:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},'If any DVC in the quorum is ahead of the primary by more than one checkpoint,\nthe new primary "forfeits" (that is, it immediately triggers another view change).'),(0,n.kt)("li",{parentName:"ol"},"If any DVC in the quorum is ahead of the primary by more than one checkpoint,\nand any messages in the next checkpoint are possibly committed,\nthe new primary forfeits."),(0,n.kt)("li",{parentName:"ol"},"The primary installs the headers to its suffix."),(0,n.kt)("li",{parentName:"ol"},"Then the primary repairs its headers. (",(0,n.kt)("a",{parentName:"li",href:"#protocol-repair-journal"},"Protocol: Repair Journal"),")."),(0,n.kt)("li",{parentName:"ol"},"Then the primary repairs its prepares. (",(0,n.kt)("a",{parentName:"li",href:"#protocol-repair-wal"},"Protocol: Repair WAL"),") (and potentially truncates uncommitted ops)."),(0,n.kt)("li",{parentName:"ol"},"Then primary commits all prepares which are not known to be uncommitted."),(0,n.kt)("li",{parentName:"ol"},"Then the primary transitions to ",(0,n.kt)("inlineCode",{parentName:"li"},"status=normal")," and broadcasts a ",(0,n.kt)("inlineCode",{parentName:"li"},"command=start_view"),".")),(0,n.kt)("h2",{id:"protocol-requeststart-view"},"Protocol: Request/Start View"),(0,n.kt)("h3",{id:"request_start_view"},(0,n.kt)("inlineCode",{parentName:"h3"},"request_start_view")),(0,n.kt)("p",null,"A backup sends a ",(0,n.kt)("inlineCode",{parentName:"p"},"command=request_start_view")," to the primary of a view when any of the following occur:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"the backup learns about a newer view via a ",(0,n.kt)("inlineCode",{parentName:"li"},"command=commit")," message, or"),(0,n.kt)("li",{parentName:"ul"},"the backup learns about a newer view via a ",(0,n.kt)("inlineCode",{parentName:"li"},"command=prepare")," message, or"),(0,n.kt)("li",{parentName:"ul"},"the backup discovers ",(0,n.kt)("inlineCode",{parentName:"li"},"commit_max")," exceeds ",(0,n.kt)("inlineCode",{parentName:"li"},"min(op_head, op_checkpoint_trigger)")," (during repair), or"),(0,n.kt)("li",{parentName:"ul"},"a replica recovers to ",(0,n.kt)("inlineCode",{parentName:"li"},"status=recovering_head"))),(0,n.kt)("h3",{id:"start_view"},(0,n.kt)("inlineCode",{parentName:"h3"},"start_view")),(0,n.kt)("p",null,"When a ",(0,n.kt)("inlineCode",{parentName:"p"},"status=normal")," primary receives ",(0,n.kt)("inlineCode",{parentName:"p"},"command=request_start_view"),", it replies with a ",(0,n.kt)("inlineCode",{parentName:"p"},"command=start_view"),".\n",(0,n.kt)("inlineCode",{parentName:"p"},"command=start_view")," includes the view's current suffix \u2014 the headers of the latest messages in the view."),(0,n.kt)("p",null,"Upon receiving a ",(0,n.kt)("inlineCode",{parentName:"p"},"start_view")," for the new view, the backup installs the suffix, transitions to ",(0,n.kt)("inlineCode",{parentName:"p"},"status=normal"),", and begins repair."),(0,n.kt)("p",null,"A ",(0,n.kt)("inlineCode",{parentName:"p"},"start_view")," contains the following headers (which may overlap):"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"The suffix: ",(0,n.kt)("inlineCode",{parentName:"li"},"pipeline_prepare_queue_max")," headers from the head op down."),(0,n.kt)("li",{parentName:"ul"},'The "hooks": the header of any previous checkpoint triggers within our repairable range.\nThis helps a lagging replica catch up. (There are at most 2).')),(0,n.kt)("h2",{id:"protocol-repair-journal"},"Protocol: Repair Journal"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"request_headers")," and ",(0,n.kt)("inlineCode",{parentName:"p"},"headers")," repair gaps or breaks in a replica's journal headers.\nRepaired headers are a prerequisite for ",(0,n.kt)("a",{parentName:"p",href:"#protocol-repair-wal"},"repairing prepares"),"."),(0,n.kt)("p",null,"Because the headers are repaired backwards (from the head) by hash-chaining, it is safe for both backups and transitioning primaries."),(0,n.kt)("p",null,"Gaps/breaks in a replica's journal headers may occur:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"On a backup, receiving nonconsecutive ops, leaving a gap in its headers."),(0,n.kt)("li",{parentName:"ul"},"On a backup, which has not finished repair."),(0,n.kt)("li",{parentName:"ul"},"On a new primary during a view-change, which has not finished repair.")),(0,n.kt)("h2",{id:"protocol-repair-wal"},"Protocol: Repair WAL"),(0,n.kt)("p",null,"The replica's journal tracks which prepares the WAL requires \u2014 i.e. headers for which either:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"no prepare was ever received, or"),(0,n.kt)("li",{parentName:"ul"},"the prepare was received and written, but was since discovered to be corrupt")),(0,n.kt)("p",null,"During repair, missing/damaged prepares are requested & repaired chronologically, which:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"improves the chances that older entries will be available, i.e. not yet overwritten"),(0,n.kt)("li",{parentName:"ul"},"enables better pipelining of repair and commit.")),(0,n.kt)("p",null,"In response to a ",(0,n.kt)("inlineCode",{parentName:"p"},"request_prepare"),":"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Reply the ",(0,n.kt)("inlineCode",{parentName:"li"},"command=prepare")," with the requested prepare, if available and valid."),(0,n.kt)("li",{parentName:"ul"},"Otherwise do not reply. (e.g. the corresponding slot in the WAL is corrupt)")),(0,n.kt)("p",null,"Per ",(0,n.kt)("a",{parentName:"p",href:"https://www.usenix.org/system/files/conference/fast18/fast18-alagappan.pdf"},"PAR's CTRL Protocol"),", we do not nack corrupt entries, since they ",(0,n.kt)("em",{parentName:"p"},"might")," be the prepare being requested."),(0,n.kt)("h2",{id:"protocol-repair-client-table"},"Protocol: Repair Client Table"),(0,n.kt)("p",null,"The replica's client table stores the latest reply to each active client."),(0,n.kt)("p",null,"During repair, corrupt replies are requested & repaired."),(0,n.kt)("p",null,"In response to a ",(0,n.kt)("inlineCode",{parentName:"p"},"request_reply"),":"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Respond with the ",(0,n.kt)("inlineCode",{parentName:"li"},"command=reply")," (the requested reply), if available and valid."),(0,n.kt)("li",{parentName:"ul"},"Otherwise do not reply.")),(0,n.kt)("h2",{id:"protocol-client"},"Protocol: Client"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Client sends ",(0,n.kt)("inlineCode",{parentName:"li"},"command=request operation=register")," to registers with the cluster by starting a new request-reply hashchain. (See also: ",(0,n.kt)("a",{parentName:"li",href:"#protocol-normal"},"Protocol: Normal"),")."),(0,n.kt)("li",{parentName:"ol"},"Client receives ",(0,n.kt)("inlineCode",{parentName:"li"},"command=reply operation=register")," from the cluster. (If the cluster is at the maximum number of clients, it evicts the oldest)."),(0,n.kt)("li",{parentName:"ol"},"Repeat:",(0,n.kt)("ol",{parentName:"li"},(0,n.kt)("li",{parentName:"ol"},"Send ",(0,n.kt)("inlineCode",{parentName:"li"},"command=request")," to cluster."),(0,n.kt)("li",{parentName:"ol"},"If the client has been evicted, receive ",(0,n.kt)("inlineCode",{parentName:"li"},"command=eviction")," from the cluster. (The client must re-register before sending more requests.)"),(0,n.kt)("li",{parentName:"ol"},"If the client has not been evicted, receive ",(0,n.kt)("inlineCode",{parentName:"li"},"command=reply")," from cluster.")))),(0,n.kt)("p",null,"See also:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"/design/client-sessions#lifecycle"},"Integration: Client Session Lifecycle")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"/design/client-sessions#eviction"},"Integration: Client Session Eviction"))),(0,n.kt)("h2",{id:"protocol-repair-grid"},"Protocol: Repair Grid"),(0,n.kt)("p",null,"Grid repair is triggered when a replica discovers a corrupt (or missing) grid block."),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"The repairing replica sends a ",(0,n.kt)("inlineCode",{parentName:"li"},"command=request_blocks")," to any other replica. The message body contains a list of block ",(0,n.kt)("inlineCode",{parentName:"li"},"address"),"/",(0,n.kt)("inlineCode",{parentName:"li"},"checksum"),"s."),(0,n.kt)("li",{parentName:"ol"},"Upon receiving a ",(0,n.kt)("inlineCode",{parentName:"li"},"command=request_blocks"),", a replica reads its own grid to check for the requested blocks. For each matching block found, reply with the ",(0,n.kt)("inlineCode",{parentName:"li"},"command=block")," message (the block itself)."),(0,n.kt)("li",{parentName:"ol"},"Upon receiving a ",(0,n.kt)("inlineCode",{parentName:"li"},"command=block"),", a replica writes the block to its grid, and resolves the reads that were blocked on it.")),(0,n.kt)("p",null,"Note that ",(0,n.kt)("em",{parentName:"p"},"both sides")," of grid repair can run while the grid is being opened during replica startup.\nThat is, a replica can help other replicas repair and repair itself simultaneously."),(0,n.kt)("p",null,"TODO Describe state sync fallback."),(0,n.kt)("h2",{id:"protocol-repair-state-sync"},"Protocol: Repair: State Sync"),(0,n.kt)("p",null,"TODO (Unimplemented)"),(0,n.kt)("h2",{id:"protocol-reconfiguration"},"Protocol: Reconfiguration"),(0,n.kt)("p",null,"TODO (Unimplemented)"),(0,n.kt)("h1",{id:"quorums"},"Quorums"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"The ",(0,n.kt)("em",{parentName:"li"},"replication quorum")," is the minimum number of replicas required to complete a commit."),(0,n.kt)("li",{parentName:"ul"},"The ",(0,n.kt)("em",{parentName:"li"},"view-change quorum")," is the minimum number of replicas required to complete a view-change."),(0,n.kt)("li",{parentName:"ul"},"The ",(0,n.kt)("em",{parentName:"li"},"nack quorum")," is the minimum number of unique nacks required to truncate an uncommitted op.")),(0,n.kt)("p",null,"With the default configuration:"),(0,n.kt)("table",null,(0,n.kt)("thead",{parentName:"table"},(0,n.kt)("tr",{parentName:"thead"},(0,n.kt)("th",{parentName:"tr",align:"right"},(0,n.kt)("strong",{parentName:"th"},"Replica Count")),(0,n.kt)("th",{parentName:"tr",align:"right"},"1"),(0,n.kt)("th",{parentName:"tr",align:"right"},"2"),(0,n.kt)("th",{parentName:"tr",align:"right"},"3"),(0,n.kt)("th",{parentName:"tr",align:"right"},"4"),(0,n.kt)("th",{parentName:"tr",align:"right"},"5"),(0,n.kt)("th",{parentName:"tr",align:"right"},"6"))),(0,n.kt)("tbody",{parentName:"table"},(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("strong",{parentName:"td"},"Replication Quorum")),(0,n.kt)("td",{parentName:"tr",align:"right"},"1"),(0,n.kt)("td",{parentName:"tr",align:"right"},"2"),(0,n.kt)("td",{parentName:"tr",align:"right"},"2"),(0,n.kt)("td",{parentName:"tr",align:"right"},"2"),(0,n.kt)("td",{parentName:"tr",align:"right"},"3"),(0,n.kt)("td",{parentName:"tr",align:"right"},"3")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("strong",{parentName:"td"},"View-Change Quorum")),(0,n.kt)("td",{parentName:"tr",align:"right"},"1"),(0,n.kt)("td",{parentName:"tr",align:"right"},"2"),(0,n.kt)("td",{parentName:"tr",align:"right"},"2"),(0,n.kt)("td",{parentName:"tr",align:"right"},"3"),(0,n.kt)("td",{parentName:"tr",align:"right"},"3"),(0,n.kt)("td",{parentName:"tr",align:"right"},"4")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("strong",{parentName:"td"},"Nack Quorum")),(0,n.kt)("td",{parentName:"tr",align:"right"},"1"),(0,n.kt)("td",{parentName:"tr",align:"right"},(0,n.kt)("strong",{parentName:"td"},"1")),(0,n.kt)("td",{parentName:"tr",align:"right"},"2"),(0,n.kt)("td",{parentName:"tr",align:"right"},"3"),(0,n.kt)("td",{parentName:"tr",align:"right"},"3"),(0,n.kt)("td",{parentName:"tr",align:"right"},"4")))),(0,n.kt)("p",null,"See also:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"constants.quorum_replication_max")," for configuration."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://fpaxos.github.io/"},"Flexible Paxos"))),(0,n.kt)("h2",{id:"further-reading"},"Further reading"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://pmg.csail.mit.edu/papers/vr-revisited.pdf"},"Viewstamped Replication Revisited")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://www.usenix.org/system/files/conference/fast18/fast18-alagappan.pdf"},"Protocol Aware Recovery"))))}d.isMDXComponent=!0}}]);