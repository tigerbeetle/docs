"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[5610],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),s=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=s(e.components);return a.createElement(c.Provider,{value:t},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},f=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,c=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),d=s(n),f=r,m=d["".concat(c,".").concat(f)]||d[f]||p[f]||l;return n?a.createElement(m,i(i({ref:t},u),{},{components:n})):a.createElement(m,i({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=f;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o[d]="string"==typeof e?e:r,i[1]=o;for(var s=2;s<l;s++)i[s]=n[s];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}f.displayName="MDXCreateElement"},5030:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>l,metadata:()=>o,toc:()=>s});var a=n(7462),r=(n(7294),n(3905));const l={sidebar_position:4},i="Balance-Conditional Transfers",o={unversionedId:"coding/recipes/balance-conditional-transfers",id:"coding/recipes/balance-conditional-transfers",title:"Balance-Conditional Transfers",description:"In some use cases, you may want to execute a transfer if and only if an account has at least a",source:"@site/pages/coding/recipes/balance-conditional-transfers.md",sourceDirName:"coding/recipes",slug:"/coding/recipes/balance-conditional-transfers",permalink:"/coding/recipes/balance-conditional-transfers",draft:!1,editUrl:"https://github.com/tigerbeetle/tigerbeetle/blob/main/docs/coding/recipes/balance-conditional-transfers.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Close Account",permalink:"/coding/recipes/close-account"},next:{title:"Balance Bounds",permalink:"/coding/recipes/balance-bounds"}},c={},s=[{value:"Preconditions",id:"preconditions",level:2},{value:"1. Target Account Must Have a Limited Balance",id:"1-target-account-must-have-a-limited-balance",level:3},{value:"2. Create a Control Account",id:"2-create-a-control-account",level:3},{value:"Executing a Balance-Conditional Transfer",id:"executing-a-balance-conditional-transfer",level:2},{value:"If the Source Account Has a Credit Balance",id:"if-the-source-account-has-a-credit-balance",level:3},{value:"If the Source Account Has a Debit Balance",id:"if-the-source-account-has-a-debit-balance",level:3},{value:"Understanding the Mechanism",id:"understanding-the-mechanism",level:3}],u={toc:s},d="wrapper";function p(e){let{components:t,...n}=e;return(0,r.kt)(d,(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"balance-conditional-transfers"},"Balance-Conditional Transfers"),(0,r.kt)("p",null,"In some use cases, you may want to execute a transfer if and only if an account has at least a\ncertain balance."),(0,r.kt)("p",null,"It would be unsafe to check an account's balance using the\n",(0,r.kt)("a",{parentName:"p",href:"/reference/requests/lookup_accounts"},(0,r.kt)("inlineCode",{parentName:"a"},"lookup_accounts"))," and then perform the transfer,\nbecause these requests are not be atomic and the account's balance may change between the lookup and\nthe transfer."),(0,r.kt)("p",null,"You can atomically run a check against an account's balance before executing a transfer by using a\ncontrol or temporary account and linked transfers."),(0,r.kt)("h2",{id:"preconditions"},"Preconditions"),(0,r.kt)("h3",{id:"1-target-account-must-have-a-limited-balance"},"1. Target Account Must Have a Limited Balance"),(0,r.kt)("p",null,"The account for whom you want to do the balance check must have one of these flags set:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/reference/account#flagsdebits_must_not_exceed_credits"},(0,r.kt)("inlineCode",{parentName:"a"},"flags.debits_must_not_exceed_credits")),"\nfor accounts with ",(0,r.kt)("a",{parentName:"li",href:"/coding/data-modeling#credit-balances"},"credit balances")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/reference/account#flagscredits_must_not_exceed_debits"},(0,r.kt)("inlineCode",{parentName:"a"},"flags.credits_must_not_exceed_debits")),"\nfor accounts with ",(0,r.kt)("a",{parentName:"li",href:"/coding/data-modeling#debit-balances"},"debit balances"))),(0,r.kt)("h3",{id:"2-create-a-control-account"},"2. Create a Control Account"),(0,r.kt)("p",null,"There must also be a designated control account. As you can see below, this account will never\nactually take control of the target account's funds, but we will set up simultaneous transfers in\nand out of the control account."),(0,r.kt)("h2",{id:"executing-a-balance-conditional-transfer"},"Executing a Balance-Conditional Transfer"),(0,r.kt)("p",null,"The balance-conditional transfer consists of 3\n",(0,r.kt)("a",{parentName:"p",href:"/reference/requests/#linked-events"},"linked transfers"),"."),(0,r.kt)("p",null,"We will refer to two amounts:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("strong",{parentName:"li"},"threshold amount")," is the minimum amount the target account should have in order to execute\nthe transfer."),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("strong",{parentName:"li"},"transfer amount")," is the amount we want to transfer if and only if the target account's\nbalance meets the threshold.")),(0,r.kt)("h3",{id:"if-the-source-account-has-a-credit-balance"},"If the Source Account Has a Credit Balance"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Transfer"),(0,r.kt)("th",{parentName:"tr",align:null},"Debit Account"),(0,r.kt)("th",{parentName:"tr",align:null},"Credit Account"),(0,r.kt)("th",{parentName:"tr",align:null},"Amount"),(0,r.kt)("th",{parentName:"tr",align:null},"Pending Id"),(0,r.kt)("th",{parentName:"tr",align:null},"Flags"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"1"),(0,r.kt)("td",{parentName:"tr",align:null},"Source"),(0,r.kt)("td",{parentName:"tr",align:null},"Control"),(0,r.kt)("td",{parentName:"tr",align:null},"Threshold"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"/reference/transfer#flagslinked"},(0,r.kt)("inlineCode",{parentName:"a"},"flags.linked")),", ",(0,r.kt)("a",{parentName:"td",href:"/reference/transfer#flagspending"},(0,r.kt)("inlineCode",{parentName:"a"},"pending")))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"2"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"1"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"/reference/transfer#flagslinked"},(0,r.kt)("inlineCode",{parentName:"a"},"flags.linked")),", ",(0,r.kt)("a",{parentName:"td",href:"/reference/transfer#flagsvoid_pending_transfer"},(0,r.kt)("inlineCode",{parentName:"a"},"void_pending_transfer")))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"3"),(0,r.kt)("td",{parentName:"tr",align:null},"Source"),(0,r.kt)("td",{parentName:"tr",align:null},"Destination"),(0,r.kt)("td",{parentName:"tr",align:null},"Transfer"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"N/A")))),(0,r.kt)("h3",{id:"if-the-source-account-has-a-debit-balance"},"If the Source Account Has a Debit Balance"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Transfer"),(0,r.kt)("th",{parentName:"tr",align:null},"Debit Account"),(0,r.kt)("th",{parentName:"tr",align:null},"Credit Account"),(0,r.kt)("th",{parentName:"tr",align:null},"Amount"),(0,r.kt)("th",{parentName:"tr",align:null},"Pending Id"),(0,r.kt)("th",{parentName:"tr",align:null},"Flags"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"1"),(0,r.kt)("td",{parentName:"tr",align:null},"Control"),(0,r.kt)("td",{parentName:"tr",align:null},"Source"),(0,r.kt)("td",{parentName:"tr",align:null},"Threshold"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"/reference/transfer#flagslinked"},(0,r.kt)("inlineCode",{parentName:"a"},"flags.linked")),", ",(0,r.kt)("a",{parentName:"td",href:"/reference/transfer#flagspending"},(0,r.kt)("inlineCode",{parentName:"a"},"pending")))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"2"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"1"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"/reference/transfer#flagslinked"},(0,r.kt)("inlineCode",{parentName:"a"},"flags.linked")),", ",(0,r.kt)("a",{parentName:"td",href:"/reference/transfer#flagsvoid_pending_transfer"},(0,r.kt)("inlineCode",{parentName:"a"},"void_pending_transfer")))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"3"),(0,r.kt)("td",{parentName:"tr",align:null},"Destination"),(0,r.kt)("td",{parentName:"tr",align:null},"Source"),(0,r.kt)("td",{parentName:"tr",align:null},"Transfer"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"N/A")))),(0,r.kt)("h3",{id:"understanding-the-mechanism"},"Understanding the Mechanism"),(0,r.kt)("p",null,"Each of the 3 transfers is linked, meaning they will all succeed or fail together."),(0,r.kt)("p",null,"The first transfer attempts to transfer the threshold amount to the control account. If this\ntransfer would cause the source account's net balance to go below zero, the account's balance limit\nflag would ensure that the first transfer fails. If the first transfer fails, the other two linked\ntransfers would also fail."),(0,r.kt)("p",null,"If the first transfer succeeds, it means that the source account did have the threshold balance. In\nthis case, the second transfer cancels the first transfer (returning the threshold amount to the\nsource account). Then, the third transfer would execute the desired transfer to the ultimate\ndestination account."),(0,r.kt)("p",null,"Note that in the tables above, we do the balance check on the source account. The balance check\ncould also be applied to the destination account instead."))}p.isMDXComponent=!0}}]);