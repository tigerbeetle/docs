<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-internals/sync">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">State Sync | TigerBeetle Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.tigerbeetle.com/internals/sync"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="State Sync | TigerBeetle Docs"><meta data-rh="true" name="description" content="State sync synchronizes the state of a lagging/divergent replica with the healthy cluster."><meta data-rh="true" property="og:description" content="State sync synchronizes the state of a lagging/divergent replica with the healthy cluster."><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://docs.tigerbeetle.com/internals/sync"><link data-rh="true" rel="alternate" href="https://docs.tigerbeetle.com/internals/sync" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.tigerbeetle.com/internals/sync" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://NPDIZGXHAP-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="TigerBeetle Docs" href="/opensearch.xml">

<script src="https://plausible.io/js/script.js" defer="defer" data-domain="docs.tigerbeetle.com"></script><link rel="stylesheet" href="/assets/css/styles.6ee9f562.css">
<link rel="preload" href="/assets/js/runtime~main.a2689e27.js" as="script">
<link rel="preload" href="/assets/js/main.476d745f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="TigerBeetle Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="TigerBeetle Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">TigerBeetle Docs</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tigerbeetledb/tigerbeetle" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">TigerBeetle Docs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/quick-start/">Quick Start</a><button aria-label="Toggle the collapsible sidebar category &#x27;Quick Start&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/design/client-requests">Design</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/deploy/hardware">Deploy</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/recipes/close-account">Recipes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/clients/dotnet">Client Libraries</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/reference/accounts">Reference</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/FAQ">FAQ</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/internals/">Internals</a><button aria-label="Toggle the collapsible sidebar category &#x27;Internals&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/internals/vsr">VSR</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/internals/lsm">LSM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/internals/sync">State Sync</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/internals/testing">Testing</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/internals/"><span itemprop="name">Internals</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">State Sync</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>State Sync</h1><p>State sync synchronizes the state of a lagging/divergent replica with the healthy cluster.</p><p>State sync is used when when a lagging replica&#x27;s log no longer intersects with the cluster&#x27;s current log —
<a href="/internals/vsr#protocol-repair-wal">WAL repair</a> cannot catch the replica up.</p><p>(VRR refers to state sync as &quot;state transfer&quot;, but we already have <a href="/reference/transfers">transfers</a> elsewhere.)</p><p>In the context of state sync, &quot;state&quot; refers to:</p><ol><li>the superblock manifest</li><li>the superblock free set</li><li>the superblock client sessions</li><li>the superblock <code>vsr_state.commit_min</code></li><li>the superblock <code>vsr_state.commit_min_checksum</code></li><li>the grid (LSM data; acquired blocks only)</li><li>client replies</li></ol><p>However, state sync protocol itself only syncs the first 5.
6/7 are replicated after state sync protocol, driven by grid repair and the disk scrubber.</p><p>The target of state sync is the latest checkpoint of the healthy cluster.
When we catch up to the latest checkpoint (or very close to it), then we can transition back to a healthy state.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="glossary">Glossary<a href="#glossary" class="hash-link" aria-label="Direct link to Glossary" title="Direct link to Glossary">​</a></h2><p>Replica roles:</p><ul><li><em>syncing replica</em>: A replica performing state sync. (Any step within <em>1</em>-<em>9</em> of the <a href="#algorithm">sync algorithm</a>)</li><li><em>healthy replica</em>: A replica <em>not</em> performing state sync — part of the active cluster.</li><li><em>divergent replica</em>: A replica with a checkpoint that is (and can never be) canonical.</li></ul><p>Checkpoints:</p><ul><li><a href="#checkpoint-identifier"><em>checkpoint id</em>/<em>checkpoint identifier</em></a>: Uniquely identifies a particular checkpoint reproducibly across replicas.</li><li><a href="#canonical-checkpoint"><em>canonical checkpoint</em></a>: Any checkpoint which either: <em>A</em>: has any ops committed atop it by the primary, or <em>B</em>: a majority quorum has reached.</li><li><a href="#sync-target"><em>sync target</em></a>: The checkpoint identifier of the target of state sync. Every sync target is a canonical checkpoint.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="algorithm">Algorithm<a href="#algorithm" class="hash-link" aria-label="Direct link to Algorithm" title="Direct link to Algorithm">​</a></h2><ol start="0"><li><a href="#0-scenarios">Sync is needed</a>.</li><li><a href="#1-triggers">Trigger sync</a>.</li><li>Wait for non-grid commit operation to finish.</li><li>Wait for grid IO to finish. (See <code>Grid.cancel()</code>.)</li><li>Wait for a usable sync target to arrive. (Usually we already have one.)</li><li><a href="#5-request-superblock-trailers">Request superblock trailers</a>.</li><li>Update superblock headers:<ul><li>Bump <code>vsr_state.commit_min</code>/<code>vsr_state.commit_min_checksum</code> to the sync target op/op-checksum.</li><li>Bump <code>vsr_state.previous_checkpoint_id</code> to the checkpoint id that is previous to our sync target (i.e. it isn&#x27;t <em>our</em> previous checkpoint).</li><li>Bump <code>replica.commit_min</code>. (If <code>replica.commit_min</code> exceeds <code>replica.op</code>, transition to <code>status=recovering_head</code>).</li><li>Write the target checkpoint&#x27;s trailers.</li></ul></li><li>Request and write manifest log blocks. (Handled by <a href="/internals/vsr#protocol-repair-grid">Grid Repair Protocol</a>.)</li><li>Request and write table blocks. (TODO: This step is not implemented yet.)</li><li>Done.</li></ol><p>If a newer sync target is discovered during steps <em>4</em>-<em>8</em>, go to step <em>3</em>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="0-scenarios">0: Scenarios<a href="#0-scenarios" class="hash-link" aria-label="Direct link to 0: Scenarios" title="Direct link to 0: Scenarios">​</a></h3><p>Scenarios requiring state sync:</p><ol><li>A replica was down/partitioned/slow for a while and the rest of the cluster moved on.
The lagging replica is too far behind to catch up via WAL repair.</li><li>A replica was just formatted and is being added to the cluster (i.e. via <a href="/internals/vsr#protocol-reconfiguration">reconfiguration</a>).
The new replica is too far behind to catch up via WAL repair.</li><li>A replica&#x27;s state diverged from the cluster (<a href="#storage-determinism">storage nondeterminism</a>).</li></ol><p>Causes of number 3:</p><ul><li>A storage determinism bug.</li><li>An upgraded replica (e.g. a canary) running a different version of the code from the remainder of the cluster, which unexpectedly changes its history.
(The change either has a bug or should have been gated behind a feature flag.)</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-triggers">1: Triggers<a href="#1-triggers" class="hash-link" aria-label="Direct link to 1: Triggers" title="Direct link to 1: Triggers">​</a></h3><p>State sync is initially triggered by any of the following:</p><ul><li>The replica discovers the canonical checkpoint for its current wrap, and that it <a href="#storage-determinism">doesn&#x27;t match</a> its own current checkpoint.</li><li>The replica receives a SV which indicates that it has lagged so far behind the cluster that its log cannot possibly intersect.</li><li><code>repair_sync_timeout</code> fires, and:<ul><li>a WAL or grid repair is in progress and,</li><li>the replica&#x27;s checkpoint is lagging behind the cluster&#x27;s (far enough that the repair may never complete).</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-request-superblock-trailers">5: Request Superblock Trailers<a href="#5-request-superblock-trailers" class="hash-link" aria-label="Direct link to 5: Request Superblock Trailers" title="Direct link to 5: Request Superblock Trailers">​</a></h3><p>The replica concurrently sends out three request messages, with the sync target identifier attached to each:</p><ol><li><code>command=request_sync_manifest</code></li><li><code>command=request_sync_free_set</code></li><li><code>command=request_sync_client_sessions</code></li></ol><p>Replicas with a matching checkpoint identifier reply (respectively) with:</p><ol><li><code>command=sync_manifest</code></li><li><code>command=sync_free_set</code></li><li><code>command=sync_client_sessions</code></li></ol><p>If a trailer is too large to fit in a message, the syncing replica requests it again, with a byte offset.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="concepts">Concepts<a href="#concepts" class="hash-link" aria-label="Direct link to Concepts" title="Direct link to Concepts">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="syncing-replica">Syncing Replica<a href="#syncing-replica" class="hash-link" aria-label="Direct link to Syncing Replica" title="Direct link to Syncing Replica">​</a></h3><p>Syncing replicas may:</p><ul><li><a href="#syncing-replicas-write-prepares-to-their-wal">write prepares to their WAL</a></li><li>assist with grid repair</li><li>join new views</li><li>send a <code>do_view_change</code></li></ul><p>Syncing replicas must not:</p><ul><li><a href="#syncing-replicas-dont-ack-prepares">ack</a></li><li>commit prepares</li><li>be a primary</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="syncing-replicas-write-prepares-to-their-wal">Syncing Replicas write prepares to their WAL.<a href="#syncing-replicas-write-prepares-to-their-wal" class="hash-link" aria-label="Direct link to Syncing Replicas write prepares to their WAL." title="Direct link to Syncing Replicas write prepares to their WAL.">​</a></h4><p>When the replica completes state sync, an up-to-date WAL and journal allow it to quickly catch up (i.e. commit) to the current cluster state.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="syncing-replicas-dont-ack-prepares">Syncing Replicas don&#x27;t ack prepares.<a href="#syncing-replicas-dont-ack-prepares" class="hash-link" aria-label="Direct link to Syncing Replicas don&#x27;t ack prepares." title="Direct link to Syncing Replicas don&#x27;t ack prepares.">​</a></h4><p>If syncing replicas <em>did</em> ack prepares:</p><p>Consider a cluster of 3 replicas:</p><ul><li>the <em>primary</em>,</li><li>a <em>normal backup</em>, and</li><li>a <em>syncing backup</em>.</li></ul><ol><li><em>Primary</em> prepares many ops...</li><li><em>Syncing backup</em> prepares and acknowledges all of those messages.</li><li><em>Normal backup</em> is partitioned — its not seeing any of these prepares.</li><li><em>Primary</em> is receiving <code>prepare_ok</code>s from the <em>syncing backup</em>, so it is committing.</li><li><em>Primary</em> eventually checkpoints.</li><li>(This cycle repeats — <em>primary</em> keeps preparing/committing, <em>syncing backup</em> keeps preparing, and <em>normal backup</em> is still partitioned.)</li></ol><p>But now <em>primary</em> is so far ahead that the <em>normal backup</em> needs to sync!
Having 2/3 replicas syncing means that a single grid-block corruption on the primary could make the cluster permanently unavailable.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="checkpoint-identifier">Checkpoint Identifier<a href="#checkpoint-identifier" class="hash-link" aria-label="Direct link to Checkpoint Identifier" title="Direct link to Checkpoint Identifier">​</a></h3><p>A <em>checkpoint id</em> is a hash of the superblock trailers.</p><p>A checkpoint identifier is attached to the following message types:</p><ul><li><code>command=commit</code>: Current checkpoint identifier of sender.</li><li><code>command=ping</code>: Current checkpoint identifier of sender.</li><li><code>command=prepare_ok</code>: The attached checkpoint id is the checkpoint id during which the corresponding prepare was originally prepared.</li><li><code>command=request_sync_manifest</code>: Requested checkpoint identifier.</li><li><code>command=request_sync_free_set</code>: Requested checkpoint identifier.</li><li><code>command=request_sync_client_sessions</code>: Requested checkpoint identifier.</li><li><code>command=sync_manifest</code>: Current checkpoint identifier of sender.</li><li><code>command=sync_free_set</code>: Current checkpoint identifier of sender.</li><li><code>command=sync_client_sessions</code>: Current checkpoint identifier of sender.</li></ul><p>TODO(Big headers): Add checkpoint identifier to <code>command=prepare</code> too, so that a backup cannot diverge by &gt;1 checkpoint if it is partitioned from only <code>command=commit</code> and <code>commit=ping</code> messages.
(And once <code>prepare</code> holds the checkpoint identifier, can it be omitted on <code>prepare_ok</code>A? Just don&#x27;t ack if different?)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="canonical-checkpoint">Canonical Checkpoint<a href="#canonical-checkpoint" class="hash-link" aria-label="Direct link to Canonical Checkpoint" title="Direct link to Canonical Checkpoint">​</a></h3><p>A <em>canonical</em> checkpoint is a checkpoint:</p><ol><li>with an op committed atop it by the primary (discovery via <code>command=commit</code>), or</li><li>that a majority quorum of replicas have reached (discovery via <code>command=ping</code>), or</li><li>(when <code>R=2</code>: that a single replica has reached).</li></ol><p>The primary ignores <code>command=prepare_ok</code>s which have a different checkpoint id attached than they expect.
This means that if a replica&#x27;s history diverges (due to nondeterminism), the diverging replica is effectively excluded from participating in consensus until it has performed state sync.
See <a href="#storage-determinism">Storage Determinism</a>.</p><p>This bounds the &quot;distance&quot; that a history can diverge by.
Every checkpoint&#x27;s previous (i.e. parent) checkpoint is canonical.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sync-target">Sync Target<a href="#sync-target" class="hash-link" aria-label="Direct link to Sync Target" title="Direct link to Sync Target">​</a></h3><p>A <em>sync target</em> is the <a href="#checkpoint-identifier">checkpoint identifier</a> of the checkpoint that the state sync is syncing towards.</p><p>Not all checkpoint identifiers are valid sync targets.</p><ul><li>Every sync target <strong>must</strong> be a <a href="#canonical-checkpoint">canonical checkpoint</a>.
(TODO: Once prepares include the checkpoint identifier, this requirement can be removed.)</li><li>Every sync target op <strong>must</strong> either:<ul><li>be greater-than-or-equal-to the replica&#x27;s current checkpoint op.</li><li>be equal to the replica&#x27;s current checkpoint op, but with a different target id (if our checkpoint diverged).</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="storage-determinism">Storage Determinism<a href="#storage-determinism" class="hash-link" aria-label="Direct link to Storage Determinism" title="Direct link to Storage Determinism">​</a></h3><p>When everything works, storage is deterministic.
But we must tolerate non-determinism too, in case of bugs.</p><p>At the limit, all 6 replicas could diverge.
This puts the cluster in a very precarious position:
All it would take is a single corruption to be permanently unavailable!
(We need to pick one &quot;winner&quot;, and we can&#x27;t just read all of every single replica&#x27;s disks to find which (if any) is completely intact).</p><p>So we must bound nondeterminism within our fault model.</p><p>We require that at least <a href="/internals/vsr#quorums"><code>quorum_replication</code></a> histories are identical.
<a href="#canonical-checkpoint">Canonical Checkpoint</a> describes how this can (in part, though not completely) be enforced automatically.
If more histories diverge, the cluster will be unavailable (unable to commit), and require operator intervention to recover (e.g. by cloning data files).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="progress-tracking">Progress Tracking<a href="#progress-tracking" class="hash-link" aria-label="Direct link to Progress Tracking" title="Direct link to Progress Tracking">​</a></h3><p>If a state-syncing replica crashes before completing sync, we don&#x27;t want to restart from scratch.
(This is mainly important for tables — the manifest is smaller.)</p><p>Progress is tracked implicitly: If a table index block is present on disk, we implicitly assume that all of its filter/data blocks have already been written too.
That is, &quot;table index block in grid&quot; implies &quot;table&#x27;s referenced data/filter blocks are in grid&quot;.</p><p>To enforce this invariant:</p><ol><li>When syncing table blocks, don&#x27;t write an index block until all of its data and filter blocks are written.</li><li>A history cannot diverge from the canonical history by more than one checkpoint.</li><li>A replica never syncs towards a checkpoint from its past.</li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/tigerbeetledb/tigerbeetle/blob/main/docs/internals/sync.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/internals/lsm"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">LSM</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/internals/testing"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Testing</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#glossary" class="table-of-contents__link toc-highlight">Glossary</a></li><li><a href="#algorithm" class="table-of-contents__link toc-highlight">Algorithm</a><ul><li><a href="#0-scenarios" class="table-of-contents__link toc-highlight">0: Scenarios</a></li><li><a href="#1-triggers" class="table-of-contents__link toc-highlight">1: Triggers</a></li><li><a href="#5-request-superblock-trailers" class="table-of-contents__link toc-highlight">5: Request Superblock Trailers</a></li></ul></li><li><a href="#concepts" class="table-of-contents__link toc-highlight">Concepts</a><ul><li><a href="#syncing-replica" class="table-of-contents__link toc-highlight">Syncing Replica</a></li><li><a href="#checkpoint-identifier" class="table-of-contents__link toc-highlight">Checkpoint Identifier</a></li><li><a href="#canonical-checkpoint" class="table-of-contents__link toc-highlight">Canonical Checkpoint</a></li><li><a href="#sync-target" class="table-of-contents__link toc-highlight">Sync Target</a></li><li><a href="#storage-determinism" class="table-of-contents__link toc-highlight">Storage Determinism</a></li><li><a href="#progress-tracking" class="table-of-contents__link toc-highlight">Progress Tracking</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/tigerbeetledb" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/tigerbeetledb/tigerbeetle" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://linkedin.com/company/tigerbeetle" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/uWCGp46uG5" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 TigerBeetle, Inc. All rights reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a2689e27.js"></script>
<script src="/assets/js/main.476d745f.js"></script>
</body>
</html>