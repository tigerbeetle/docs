"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6441],{3905:(e,t,i)=>{i.d(t,{Zo:()=>c,kt:()=>m});var n=i(7294);function r(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function a(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function o(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?a(Object(i),!0).forEach((function(t){r(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):a(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function s(e,t){if(null==e)return{};var i,n,r=function(e,t){if(null==e)return{};var i,n,r={},a=Object.keys(e);for(n=0;n<a.length;n++)i=a[n],t.indexOf(i)>=0||(r[i]=e[i]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)i=a[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(r[i]=e[i])}return r}var l=n.createContext({}),u=function(e){var t=n.useContext(l),i=t;return e&&(i="function"==typeof e?e(t):o(o({},t),e)),i},c=function(e){var t=u(e.components);return n.createElement(l.Provider,{value:t},e.children)},p="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var i=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=u(i),d=r,m=p["".concat(l,".").concat(d)]||p[d]||h[d]||a;return i?n.createElement(m,o(o({ref:t},c),{},{components:i})):n.createElement(m,o({ref:t},c))}));function m(e,t){var i=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=i.length,o=new Array(a);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[p]="string"==typeof e?e:r,o[1]=s;for(var u=2;u<a;u++)o[u]=i[u];return n.createElement.apply(null,o)}return n.createElement.apply(null,i)}d.displayName="MDXCreateElement"},8538:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>u});var n=i(7462),r=(i(7294),i(3905));const a={sidebar_position:4},o="Deterministic Simulation Testing",s={unversionedId:"about/vopr",id:"about/vopr",title:"Deterministic Simulation Testing",description:"Deterministic Simulation Testing (DST) is one of our favorite parts about TigerBeetle, and it is a",source:"@site/pages/about/vopr.md",sourceDirName:"about",slug:"/about/vopr",permalink:"/about/vopr",draft:!1,editUrl:"https://github.com/tigerbeetle/tigerbeetle/blob/main/docs/about/vopr.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Safety",permalink:"/about/safety"},next:{title:"Architecture",permalink:"/about/architecture"}},l={},u=[{value:"Live Simulator in the Browser",id:"live-simulator-in-the-browser",level:2},{value:"The VOPR",id:"the-vopr",level:2},{value:"Assertions and Checkers",id:"assertions-and-checkers",level:2},{value:"VOPR Hub",id:"vopr-hub",level:2},{value:"Inspiration",id:"inspiration",level:2},{value:"Learn More",id:"learn-more",level:2}],c={toc:u},p="wrapper";function h(e){let{components:t,...i}=e;return(0,r.kt)(p,(0,n.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"deterministic-simulation-testing"},"Deterministic Simulation Testing"),(0,r.kt)("p",null,"Deterministic Simulation Testing (DST) is one of our favorite parts about TigerBeetle, and it is a\nkey way that we improve the system's reliability."),(0,r.kt)("p",null,"Simulation testing enables us to run the production TigerBeetle code under a wide variety of\nconditions to ensure that the cluster behaves properly. Because our simulator is deterministic based\non a ",(0,r.kt)("em",{parentName:"p"},"seed")," number and the Git commit, we can perfectly reproduce any bugs discovered in testing for\neasy local debugging. Crucially, VOPR can speed up time arbitrarily. One minute of VOPR time is\nequivalent to days of real-world testing."),(0,r.kt)("h2",{id:"live-simulator-in-the-browser"},"Live Simulator in the Browser"),(0,r.kt)("p",null,"You can see the simulator in action at ",(0,r.kt)("a",{parentName:"p",href:"https://sim.tigerbeetle.com"},"https://sim.tigerbeetle.com"),"!"),(0,r.kt)("p",null,"The three modes show TigerBeetle handling different types of network and hardware conditions -- and\nyou can inject different faults yourself \ud83d\udd28\ud83e\uddca\u26a1."),(0,r.kt)("h2",{id:"the-vopr"},"The VOPR"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"The VOPR"),", or The Viewstamped Operation Replicator, is our name for our deterministic simulator.\n(The name was inspired by the AI supercomputer in the 1983 movie\n",(0,r.kt)("a",{parentName:"p",href:"https://www.imdb.com/title/tt0086567/"},"WarGames"),", which was called the War Operation Plan Response\nor WOPR, which constantly simulated scenarios in order to learn.)"),(0,r.kt)("p",null,"The key purpose of the VOPR is to test TigerBeetle's safety and liveness, and it focuses on\nconsensus and the cluster's recovery mechanisms."),(0,r.kt)("p",null,"In the simulator, all non-deterministic parts of the system are stubbed out. This includes the\nclock, network, and disk operations."),(0,r.kt)("p",null,'The VOPR uses a random seed to tune parameters for injecting different types of faults into the\nsimulation. For example, it may drop and reorder packets, partition the network, or corrupt reads\nand writes to the "disk".'),(0,r.kt)("p",null,"Using those conditions, the simulator commits several hundred batches of operations and checks that\nthey are applied as expected."),(0,r.kt)("p",null,"When a simulation causes any type of failure, the seed and Git commit hash can be used to replay\nback the exact simulation and bug. If you are interested in understanding how we debug and fix\nfailures discovered in simulation, you can watch this\n",(0,r.kt)("a",{parentName:"p",href:"https://youtu.be/kZ3xVeO0vBw?si=gaHgOzrN-X86CAmi"},"IronBeetle episode where @matklad live debugs a real simulator failure"),"."),(0,r.kt)("p",null,"Using the same deterministic simulation infrastructure, we also test for\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/tigerbeetle/tigerbeetle/blob/main/src/vsr/replica_test.zig"},"specific cases")," that\nare hard or slow to replicate through random simulation."),(0,r.kt)("h2",{id:"assertions-and-checkers"},"Assertions and Checkers"),(0,r.kt)("p",null,"Simulation testing pairs particularly well with TigerBeetle's heavy use of assertions. Throughout\nthe code base there are thousands of assertions checking that all manner of invariants hold true."),(0,r.kt)("p",null,"TigerBeetle is somewhat unique in that it keeps these assertions on, even in production. The logic\nis that it is far better to stop operating than to continue operating in an incorrect state."),(0,r.kt)("p",null,"Assertions are a force multiplier when used with simulation testing and fuzzing. If any assertion is\nbroken under a specific set of circumstances, the simulation will crash and we debug that failure."),(0,r.kt)("p",null,"On top of the assertions in the code, the simulator also includes a variety of additional checkers\nthat verify the correctness of the cluster's state. For example, TigerBeetle replicas' data files\nare designed to be byte-for-byte identical across caught-up nodes in the cluster. Some of the\nstorage checkers verify that this is the case across simulations."),(0,r.kt)("h2",{id:"vopr-hub"},"VOPR Hub"),(0,r.kt)("p",null,"At any given time, we have a server called the VOPR Hub running a set of simulations using the most\nrecently committed code."),(0,r.kt)("p",null,"Whenever a crash, assertion failure, or liveness bug is discovered, the VOPR Hub automatically opens\na Github issue with the details."),(0,r.kt)("p",null,"You can see all of the issues discovered by the VOPR Hub\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/tigerbeetle/tigerbeetle/issues?q=is%3Aissue+author%3Atigerbeetle-vopr+"},"here"),"."),(0,r.kt)("h2",{id:"inspiration"},"Inspiration"),(0,r.kt)("p",null,"TigerBeetle's approach to DST was heavily inspired by the work of\n",(0,r.kt)("a",{parentName:"p",href:"https://apple.github.io/foundationdb/testing.html"},"FoundationDB")," and\n",(0,r.kt)("a",{parentName:"p",href:"https://www.antithesis.com/solutions/problems_we_solve/"},"Antithesis"),"."),(0,r.kt)("h2",{id:"learn-more"},"Learn More"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://tigerbeetle.com/blog/2023-07-06-simulation-testing-for-liveness"},"Simulation Testing for Liveness (Blog)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://youtu.be/el-LqUTv00M?si=ltKilzPSW8c7nKVQ"},"Deterministic Simulation Testing (Video)"))))}h.isMDXComponent=!0}}]);